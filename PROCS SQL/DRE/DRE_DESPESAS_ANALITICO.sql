
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


use SIG
go

/*
-- JAN 14
 EXEC DRE_RESULTADO_ANALITICO		'20140131'
 EXEC DRE_FUNCAO_ATRASO_ANALITICO	'20140131'
 EXEC DRE_DESPESAS_ANALITICO		'20140131'

-- ABR 14
 EXEC DRE_RESULTADO_ANALITICO		'20140430'
 EXEC DRE_FUNCAO_ATRASO_ANALITICO	'20140430'
 EXEC DRE_DESPESAS_ANALITICO		'20140430'

select * from dre_atraso (nolock) where dt_fecha='20140430' and opnroper='612080874'

-- ABR 15
 EXEC DRE_RESULTADO_ANALITICO		'20150430'
 EXEC DRE_FUNCAO_ATRASO_ANALITICO	'20150430'
 EXEC DRE_DESPESAS_ANALITICO		'20150430'

select sum(vlr_lucro_bruto), sum(vlr_iss+vlr_pis+vlr_cofins),sum(vlr_irpj+vlr_cssl) from dre_atraso (nolock) where dt_fecha='20150430'

select sum(vlr_lucro_bruto), sum(vlr_iss+vlr_pis+vlr_cofins),sum(vlr_irpj+vlr_cssl) from dre_atraso (nolock) where dt_fecha='20140430'

select * from dre_atraso (nolock) where dt_fecha='20150430' and opnroper='612161144'

EXEC DRE_DESPESAS_ANALITICO		 '20150331'

 EXEC DRE_RESULTADO_ANALITICO '20150131'
 EXEC DRE_FUNCAO_ATRASO_ANALITICO '20150131'
 EXEC DRE_DESPESAS_ANALITICO '20150131'
-- FEV
 EXEC DRE_RESULTADO_ANALITICO '20150228'
 EXEC DRE_FUNCAO_ATRASO_ANALITICO '20150228'
 EXEC DRE_DESPESAS_ANALITICO '20150228'
-- MAR
 EXEC DRE_RESULTADO_ANALITICO '20150331'
 EXEC DRE_FUNCAO_ATRASO_ANALITICO '20150331'
 EXEC DRE_DESPESAS_ANALITICO '20150331'


 EXEC DRE_RESULTADO_ANALITICO '20150430'
 EXEC DRE_FUNCAO_ATRASO_ANALITICO '20150430'
 EXEC DRE_DESPESAS_ANALITICO '20150430'

 EXEC DRE_RESULTADO_ANALITICO '20150531'
 EXEC DRE_FUNCAO_ATRASO_ANALITICO '20150531'
 EXEC DRE_DESPESAS_ANALITICO '20150531'

SELECT * FROM DRE_SEM_VEIC (NOLOCK) WHERE DT_FECHA IN ('20140430','20150430')


 EXEC DRE_DESPESAS_ANALITICO '20140131'

 EXEC DRE_DESPESAS_ANALITICO '20140531'
SELECT * FROM DRE_ATRASO (NOLOCK)


SELECT 
DESCR_TIPO	AS SEGMENTO,
DT_FECHA	AS DATA_BASE,
ISNULL(CONTRATOoriginal,OPNROPER ) AS CONTRATO_ORIGINAL,
NVL_RISCO	AS NIVEL_RISCO, 
LOAN		AS LOAN_TO_VALUE,
OPQTDDPARC	AS PRAZO_CONTRATO,
PDECOR		AS NUMERO_PARCELA,
CLCEPFIS	AS CEP_CLIENTE,
CLCIDFIS	AS CIDADE_CLIENTE,
CLUFFIS		AS ESTADO_CLIENTE,
CLRENDA		AS RENDA_CLIENTE,
OCUPACAO	AS OCUPACAO_CLIENTE,
IDADE		AS IDADE_CLIENTE,
ClSexo		AS SEXO,

CASE WHEN ClESTciv='1'  THEN 'SOLTEIRO'
	 WHEN ClESTciv='2'  THEN 'CASADO'
	 WHEN ClESTciv='3'  THEN 'DESQUITADO'
	 WHEN ClESTciv='4'  THEN 'DIVORCIADO'
	 WHEN ClESTciv='5'  THEN 'VIUVO'
	 WHEN ClESTciv='9'  THEN 'OUTROS'
	 ELSE '' END	
	AS ESTADO_CIVIL,
	
CASE WHEN TIPO_CASA='A' THEN 'Alugada'
	 WHEN TIPO_CASA='C' THEN 'C/Pais'
	 WHEN TIPO_CASA='D' THEN 'De Familiares'
	 WHEN TIPO_CASA='E' THEN 'Da Empresa'
	 WHEN TIPO_CASA='F' THEN 'Financiada'
	 WHEN TIPO_CASA='H' THEN 'Hotel'
	 WHEN TIPO_CASA='O' THEN 'Outros'
	 WHEN TIPO_CASA='P' THEN 'Própria'
	 ELSE '' END AS TIPO_CASA_CLIENTE,

LojaCod AS LOJA,
LojaCEP AS CEP_LOJA,
LojaCIDADE AS CIDADE_LOJA,
LojaUF	AS UF_LOJA,
AGENTEcod AS AGENTE,
OperadorCod	AS OPERADOR,
''	AS RWA_VEICULOS,
TC		AS TARIFA_CONTRATACAO,
--DESP_PESSOAL_SUP
DESPESA_CONTRATO AS CUSTO_CONTRATACAO,
ISNULL(VLR_COMISSAO_TERCO_AV,0.0) +ISNULL(VLR_COMISSAO_DIFERIDA_36AVOS,0.0) AS CUSTO_COMISSAO,
ISNULL(VLR_RECEITA,0.0) AS RECEITA_FINANCEIRA,
DESP_CAPT_OPER AS CUSTO_FUNDING,

--  FALTA
0.0  AS CUSTO_MANUTENCAO, 
0.0  AS MARGEM_CAIXA, 

ISNULL(PASLDXMLT,0.0)+ISNULL(PASLDXMR,0.0) AS RECEITA_ATRASO,

--  FALTA
0.0  AS CUSTO_COBRANCA, 
0.0  AS DESPESA_ATRASO, 

PDD  AS DESPESA_PROVISAO, 

ISNULL(VLR_IOF,0.0)+ISNULL(VLR_ISS,0.0) + ISNULL(VLR_PIS,0.0) + ISNULL(VLR_COFINS,0.0) +
-- FALTAM
ISNULL(vlr_IRPJ,0.0)+ISNULL(VLR_CSSL,0.0) + ISNULL(VLR_CRED_TRIB,0.0)+ ISNULL(OUTRAS_TX,0.0)
AS TRIBUTOS,


PASLDXMLT,
PASLDXMR,
PDD,
VLR_PDD_ATU,
VLR_PDD_ANT,
NVL_RISCO_ANT,
VLR_PARCELA,
VLR_RETORNO,
VLR_RECEITA,
VLR_IOF,
VLR_ISS,
VLR_PIS,
VLR_COFINS,
VLR_CAPTACAO,
vlr_IRPJ,
VLR_CSSL,
VLR_CRED_TRIB,
OUTRAS_TX,
REC_APLIC_SLDO_CX,
REPASSE_AGENTE_6P,
RETORNO_LOJA,
REPASSE_AGENTE_PROMOT,
DESP_CAPT_SLD_CX,
DESP_CAPT_OPER,
DESP_PESSOAL_VDA,
DESP_PESSOAL_SUP,
SLDO_INSCRITO,
PROPORCAO_CARTEIRA,
VLR_COMISSAO,
VLR_COMISSAO_TERCO_AV,
VLR_COMISSAO_DIFERIDA_36AVOS,
VLR_FINANCIADO AS VLR_OPERADO,
DT_BASE,
vlr_comissao_diferida_pzo_Op,
COMISSAO_AV,
SLD_DIFERIR_2_3,
OPNROPER,	
PARC,
LIBERADO,
TABELADO,
OPTAC,
COMISSAO_2_3,
VLR_COMISSAO_15,
DESPESA_CONTRATO
 FROM DRE_ATRASO (NOLOCK)
	WHERE	DT_FECHA = '20150331'
	WHERE	DT_FECHA = '20150228'

	WHERE	DT_FECHA = '20150131'
 AND '20150430'
	WHERE	DT_FECHA BETWEEN '20150131' AND '20150430'



-- receita de aplicacoes
7.1.5.10.10.005-8

SELECT *	FROM	CDCSANTANAMicroCredito..COPER O (NOLOCK)
	WHERE OPNROPER='612197904'
'612099806'
SELECT SUM(SLD_INSCRITO) FROM RATING_HISTORICO (NOLOCK) WHERE DT_FECHA='20120131'
SELECT count(*) FROM RATING_HISTORICO (NOLOCK) WHERE DT_FECHA='20120131'


*/
-- PROC CARGA DRE_RESULTADO_ANALITICO  **********************************************************************************************************************************************************************************
IF EXISTS (SELECT name FROM sysobjects 
         WHERE name = 'DRE_DESPESAS_ANALITICO' AND type = 'P')
   DROP PROCEDURE [dbo].[DRE_DESPESAS_ANALITICO] 
GO

-- MENSAL
-- ***************************************
CREATE Procedure [dbo].[DRE_DESPESAS_ANALITICO] 
 (@DTREF  SMALLDATETIME )	AS  

BEGIN

DECLARE @DTINI  AS DATETIME
DECLARE @DTFIM  AS DATETIME
DECLARE @DTM1   AS DATETIME

-- INICIO DO MES DE REF
SET @DTINI = CONVERT(CHAR(4),DATEPART(YEAR,@DTREF))+
			RIGHT(RTRIM('00'+CONVERT(CHAR(2),DATEPART(MONTH,@DTREF))),2)+'01'
SET @DTFIM = @DTREF

--SET @DTM1 = DATEADD(M,-,@DTINI)
-- FIM DO MES ANT
SET @DTM1 = DATEADD(DD,-1,@DTINI)


DECLARE @CAPTACAO FLOAT
--SELECT @DTM1

--  DECLARE @DTREF DATETIME SET @DTREF ='20150430'
--  DECLARE @DTREF DATETIME SET @DTREF ='20140131'
SET @CAPTACAO =	(SELECT	MOV_D_C 
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA='811000000000000000' )

-- CAPTACAO  RETIRAR A DESPESA DE APLICACAO DE CAIXA, DEPENDE DO SALDO DE CAIXA
-- SELECT @CAPTACAO
-- DECLARE @DTREF DATETIME  SET @DTREF ='20150430'
-- DECLARE @CAIXA FLOAT
IF DATEPART(YYYY,@DTREF) <= 2013
BEGIN
	SET	@CAPTACAO =	 @CAPTACAO - isnull((SELECT	MOV_D_C 
								FROM	GER_BASE_BALANCETE (NOLOCK) 
								WHERE	DT_FECHA=@DTREF AND EMPRESA=99  -- DESPESA DE CAPTACAO  PARCIAL 1 CONTA
									AND CONTA='811300000100000000' ) ,0.0)/4.0  
END
ELSE
BEGIN
	SET	@CAPTACAO =	 @CAPTACAO - isnull((SELECT	MOV_D_C 
								FROM	GER_BASE_BALANCETE (NOLOCK) 
								WHERE	DT_FECHA=@DTREF AND EMPRESA=99  -- DESPESA DE CAPTACAO  PARCIAL 2 CONTAS DPGE1 E 2
									AND CONTA='811300000100000000' ) ,0.0)/2.0  
END

-- remove da captacao a despesa ZERA CONTA 6/17
IF  @DTREF ='20170630'
BEGIN
	SET	@CAPTACAO =	 1285988.71
END


-- SELECT @CAIXA
-- select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where NUME_cont_FMTD ='1.1.1-9'
-- CX E CAPT
-- select * from GER_BASE_BALANCETE (NOLOCK) where DT_FECHA='20150430' AND EMPRESA=1  	AND CONTA IN ('111000000000000000','811000000000000000')
-- CAPT
-- select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where NUME_cont_FMTD IN ('4.1.7','4.3.5')
-- select * from GER_BASE_BALANCETE (NOLOCK) where DT_FECHA='20150430'  	AND CONTA IN ('111000000000000000','111100000000000000','111100100000000000')  AND EMPRESA=99 
-- DESP CAPT 140K
-- select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where NUME_cont_FMTD IN ('8.1.1.30.00.001-6')
-- select * from GER_BASE_BALANCETE (NOLOCK) where DT_FECHA='20150430'  	AND CONTA IN ('811300000100000000')
-- ********************************************* CARTEIRA
DECLARE @DTPDD DATETIME
SET @DTPDD = @DTREF
IF  @DTREF < '20140831'
	SELECT	@DTPDD= CASE  WHEN DATEPART(DW,@DTPDD) = 1 THEN DATEADD(D,-2,@DTPDD)	-- DOMINGO
						  WHEN DATEPART(DW,@DTPDD) = 7 THEN DATEADD(D,-1,@DTPDD)	-- SABADO
						  ELSE @DTREF				   END
SELECT	@DTPDD

--  **** CALCULO DA CARTEIRA  ******************************************
 
DECLARE @CARTEIRA_VEICULOS FLOAT
-- CARTEIRA SEM HH
SET @CARTEIRA_VEICULOS = ISNULL((SELECT SUM(SLD_INSCRITO) FROM RATING_HISTORICO (NOLOCK) WHERE DT_FECHA=@DTPDD AND NVL_RISCO <> 'HH'  ),0.0)

DECLARE @CARTEIRA_OUTROS FLOAT
-- CARTEIRA SEM HH  OUTROS PRODUTOS
SET @CARTEIRA_OUTROS = ISNULL((SELECT SUM(SLD_INSCRITO) FROM pdd_sem_veic (NOLOCK) WHERE DT_FECHA=@DTPDD AND NVL_RISCO <> 'HH' ),0.0)
-- AJUSTA A CARTEIRA DE OUTROS VAZIA
IF  @DTREF <= '2014-02-28' AND @CARTEIRA_OUTROS = 0.0 
	SET @CARTEIRA_OUTROS = 0.02*ISNULL(@CARTEIRA_VEICULOS,0.0)


DECLARE @CARTEIRA_TTL FLOAT
SET @CARTEIRA_TTL = ISNULL(@CARTEIRA_VEICULOS,0.0) + ISNULL(@CARTEIRA_OUTROS,0.0)


--  **** 
    SELECT @CARTEIRA_OUTROS, @CARTEIRA_VEICULOS, @CARTEIRA_TTL, @CAPTACAO

-- FRACIONA A CAPTACAO DO VEICULO

DECLARE @CAPTACAO_VEIC FLOAT

SET @CAPTACAO_VEIC =@CAPTACAO / @CARTEIRA_TTL * @CARTEIRA_VEICULOS

--   
SELECT @CAPTACAO_VEIC


DECLARE @RWA_VEIC FLOAT

SET @RWA_VEIC =(SELECT RWA FROM RWA (NOLOCK) WHERE DATA_REF=@DTREF) / @CARTEIRA_TTL * @CARTEIRA_VEICULOS

-- CALCULA A PROPORCAO CARTEIRA
UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.PROPORCAO_CARTEIRA=   SLDO_INSCRITO /@CARTEIRA_VEICULOS 
	WHERE	DT_FECHA = @DTREF
	--  SE OS CONTRATOS ESTAO NA CARTEIRA, MESMO ALGUNS DIAS CONSIDERAR
		AND	NVL_RISCO NOT IN ( 'HH') -- '' somente sem prejuizo


-- CALCULA RWA PELA CARTEIRA ***********************
UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.RWA_VEICULOS=   @RWA_VEIC * PROPORCAO_CARTEIRA
	WHERE	DT_FECHA = @DTREF
		AND	NVL_RISCO NOT IN ( 'HH') -- '' somente sem prejuizo

-- VLR TABELADO NULL CONTRATOS ANTIGOS
-- SP_HELP DRE_ATRASO
UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.DESP_CAPT_OPER=   PROPORCAO_CARTEIRA * @CAPTACAO_VEIC
	WHERE	DT_FECHA = @DTREF
		AND	NVL_RISCO NOT IN ( 'HH') -- '' somente sem prejuizo, '' = liquidados no mes
--


/*
SP_HELP DRE_SEM_VEIC
DROP TABLE DRE_SEM_VEIC 

CREATE TABLE DRE_SEM_VEIC  (
DT_FECHA		DATETIME,
CARTEIRA_VEIC	FLOAT,
CARTEIRA_OUTROS	FLOAT,
CARTEIRA_TTL	FLOAT,
CAPTACAO_TTL	FLOAT,
CAPTACAO_VEIC		FLOAT,
DESPESA_SUP_TTL		FLOAT,
DESPESA_SUP_VEIC	FLOAT,
DESPESA_CAD_TTL		FLOAT,
DESPESA_CAD_VEIC	FLOAT,
DESPESA_COML_TTL	FLOAT,
DESPESA_COML_VEIC	FLOAT,
CUSTO_MANUT_TTL		FLOAT,
CUSTO_MANUT_VEIC	FLOAT,
MARGEM_CAIXA_TTL	FLOAT,
MARGEM_CAIXA_VEIC	FLOAT,
CUSTO_COBRANCA_TTL	FLOAT,
CUSTO_COBRANCA_VEIC	FLOAT,
TRIBUTO_IRPJ_TTL	FLOAT,
TRIBUTO_IRPJ_VEIC	FLOAT,
TRIBUTO_CSSL_TTL	FLOAT,
TRIBUTO_CSSL_VEIC	FLOAT,
TRIBUTO_CRED_TRIB_TTL	FLOAT,
TRIBUTO_CRED_TRIB_VEIC	FLOAT,
TRIBUTO_OUTRAS_TXA_TTL	FLOAT,
TRIBUTO_OUTRAS_TXA_VEIC	FLOAT,
CM_TARIFAS_OUTRAS_RECEITA	FLOAT,		-- CUSTO MANUTENCAO
CM_PROVISOES				FLOAT,
CM_TARIFAS_DEPESA_OPER		FLOAT,
CM_IMOBILIZADO				FLOAT,
CM_DESP_PESSOAL				FLOAT,
CM_DESP_DIRETORIA			FLOAT,
CM_ALUGUEL					FLOAT,
CM_ADM_FIXA					FLOAT,
CM_ADM_VAR					FLOAT,
CM_TARIFAS_OUTRAS_RECEITA_VEIC	FLOAT,		-- CUSTO MANUTENCAO SOMENTE VEIC
CM_PROVISOES_VEIC				FLOAT,
CM_TARIFAS_DEPESA_OPER_VEIC	FLOAT,
CM_IMOBILIZADO_VEIC			FLOAT,
CM_DESP_PESSOAL_VEIC		FLOAT,
CM_DESP_DIRETORIA_VEIC		FLOAT,
CM_ALUGUEL_VEIC				FLOAT,
CM_ADM_FIXA_VEIC			FLOAT,
CM_ADM_VAR_VEIC				FLOAT,
CM_ADM_FIXA_CM				FLOAT,
CM_ADM_FIXA_CC				FLOAT,
CM_ADM_VAR_CM				FLOAT,					
CM_ADM_VAR_CC				FLOAT,
CM_ADM_FIXA_OUTRAS			FLOAT

 )

SP_HELP DRE_SEM_VEIC
--ALTER TABLE DRE_SEM_VEIC ADD  CM_ADM_FIXA_OUTRAS			FLOAT

ALTER TABLE DRE_SEM_VEIC ADD  QTD_CARTEIRA			FLOAT
ALTER TABLE DRE_SEM_VEIC ADD  QTD_PRODUCAO			FLOAT

ALTER TABLE DRE_SEM_VEIC ADD  CM_ADM_FIXA_OUTRAS_veic		FLOAT
ALTER TABLE DRE_SEM_VEIC ADD  CM_ADM_VAR_COMUNIC			FLOAT
ALTER TABLE DRE_SEM_VEIC ADD  CM_ADM_VAR_COMUNIC_VEIC		FLOAT

Column_name	Type
CM_ADM_FIXA_OUTRAS_veic	float
CM_ADM_VAR_COMUNIC	float
CM_ADM_VAR_COMUNIC_VEIC	float
SELECT	MOV_D_C ,*
	FROM	GER_BASE_BALANCETE (NOLOCK)  	WHERE	DT_FECHA='20150430'  AND EMPRESA=99	
	AND CONTA in ('894101000100000000','894201000100000000','819251000100000000','894103000100000000')

-- DESPESAS DE CADASTRO
817631000500000000	8.1.7.63.10.005-3		Associação Comercial (Boa Vista)
817541000100000000	8.1.7.54.10.001-7	Serviços de Digitalização / SAFEDOC
817631000700000000	8.1.7.63.10.007-7	Equifax
817631000800000000	8.1.7.63.10.008-4	SERASA
817541000100000000	8.1.7.54.10.001-7	Allcheck / Kontato / Crivo
817631000500000000	8.1.7.63.10.005-3	Associação Comercial (Boa Vista)
817631000900000000	8.1.7.63.10.009-1	FIPE / TH Consultas
817631001000000000	8.1.7.63.10.010-1	Gravame/Alienação CETIP


select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nOme_cont LIKE '%Refei%'
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nOme_cont LIKE '%ALIMEN%'

-- DESPESAS DE EQUIPE COMERCIAL
	Extra Area Comercial (Refeição/Alimento/Estacionamento...)  ??
817991000600000000  8.1.7.99.10.006-5   Refeições (Operadores)
8.1.7.66.10.012-2	Estacionamento
Alimento ??
8.3.9.99.10.004-5	Big Prêmio / Prêmio Produção
8.1.7.21.10.002-6	Reparos, adaptações e conservações

-- Campo do DRE Sintético	Campo Interface
Tarifas	Custo de Manutenção  EM TAC
Provisões	Custo de Manutenção EM despesa de Provisao
Total Despesas Imobilizado	Custo de Manutenção  +++
Despesas de Pessoal	Custo de Manutenção  OK
Despesas Diretoria	Custo de Manutenção  +++
Despesa com Aluguel	Custo de Manutenção  +++
Adm. Fixa	Custo de Manutenção		+++
Adm. Variável	Custo de Manutenção	+++

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nOme_cont LIKE '%ALUGUEL%'

-- Custo de Manutenção ************************ *********************************************

-- 10 - Total Despesas Imobilizado
8.1.8.20.10.002-0	Depreciações
8.1.9.99.20.007-1	Custo Obra CJJ
-- 2 - Total Diretoria  ----------------------
1.8.8.05.02.003-3	Pró-labore
1.8.8.05.02.001-9	Pró-labore
8.1.7.51.10.003-4		Seguros
		Seminarios Diretoria		??
8.1.7.51.10.005-8		Assist. Médica Diretoria
		INSS				??
8.1.7.30.10.001-7	Enc.FGTS  diretoria??
8.1.7.30.50.001-9	Enc.INSS  diretoria??
8.1.7.66.10.006-7	IPVA
8.1.7.66.10.005-0	Manuntenção Veiculos 
8.1.7.99.10.007-2	Refeições    DIRETORIA ??
-- Despesa com Aluguel 25 em abr-15
8.1.7.06.10.001-0		Aluguel CJJ  25K sede
8.1.7.99.10.002-7	Aluguel prédio
Aluguel Sala Shop		?? ja deve estar entre os 4 alugueis...
817000000000000000   8.1.7-6	DESPESAS ADMINISTRATIVAS

--Adm. Fixa			---------------------------------
817030000000000000	8.1.7.03-3	DESPESAS DE ÁGUA, ENERGIA E GÁS
8.1.7.69.20.001-2		IPTU
8.1.7.03.10.001-3		Luz
8.1.7.57.10.050-2	Marcas e Dominios
8.1.7.57.10.011-7	Arquivo Terceirizado - Iron Mountain 
8.1.7.63.10.006-0	Assessoria Técnica - MK
8.1.7.39.10.008-7	Auditoria e Gerenciamento de Riscos - Finaud - RSM
8.1.7.39.10.011-1	Banco Central - Sisbacen - RTM
8.1.7.63.10.012-5	Consultoria Orçamento / MSCI / BESS / FONTES		
8.1.7.63.10.002-2	Honorario Advocatícios - Fixo    -- custo de cobrança?? ***********
8.1.7.57.10.009-0	Limpeza / Portaria - Visa Clean
8.1.7.06.10.002-7	Locação Xerox / Impressoras - FM
8.1.7.39.10.001-8	Manutenção Informatica (Estrutura) - Onne 
8.1.7.66.10.010-8	Motoboy - Coty Motors
8.1.7.39.10.010-4	Serviços de RH (Depto. Pessoal) - Pay System
8.1.7.57.10.014-8	Serviços de RH (Testes/Laudos/RH Bancos)
8.1.7.60.10.001-8	Serviços de Segurança - Mult Acess
8.1.7.39.10.002-5	Sistemas Inf. (CDC/FIFA) - Função Inf / ATT
8.1.7.39.10.005-6	Sistemas Inf. (Financeiro/Contábil) CFI - ZAP
-- sub ttl 2
8.1.7.99.10.009-6	ACREFI
	ANFAC n
	ANEPS n
	Sebrae / ABSCM ??
-- sub ttl 3
817991001400000000	8.1.7.99.10.014-4	Copa/Cozinha
8.1.7.99.10.007-2	Refeições
	Combustível   ??
8.1.7.66.10.003-6	Condução
8.1.7.66.10.012-2	Estacionamento
	Serviços Externos  ??
8.3.9.99.10.007-6	Publicação de Balanço / ATA Diretoria
8.1.7.45.10.002-6	Publicação de Balanço / ATA Diretoria

8.1.7.12.10.003-5	Internet-Sites/e-Mails
	Visimax - Radar  ??
	API - Consultas Telefone  ??
8.1.7.24.10.002-3	Material  Escritório
	Xerox Cópias		??
	Certidões/Firmas/Autenticação	??
8.1.7.99.10.024-7	Custas Processos Juridico
8.1.7.54.10.012-7	Custas Processos Juridico

8.1.7.42.10.001-2	Brindes
	Anuncios		??
	PPRA/PCMSO		??
8.1.7.57.10.015-5  Seguros
	8.1.7.51.10.003-4   Seguros
8.1.7.27.10.006-8  Seguros de VIda ??

	Conservação Predio - CJJ   ??
8.1.7.42.10.003-6	Doações
8.1.7.15.10.001-8	Doações
	Eventuais			??
8.1.7.99.10.009-6	Entidade de Classes

8.1.7.99.10.001-0	Jornais/Revistas
8.1.7.45.10.002-6	Marketing
8.1.7.45.10.001-9	Marketing
	MKT - impresso/Foto		OK  ?
	Despesas CJJ		??
8.1.7.99.10.008-9	Multa e Juros   de contas gerais
8.1.7.99.10.011-3	Multa e Juros
8.1.7.54.10.012-7	Multa e Juros  ??


select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) 


817661000600000000	8.1.7.66.10.006-7 IPVA
8.1.7.66.10.007-4	DPVAT
839991001500000000	8.3.9.99.10.015-5  Cursos  Cursos e Treinamentos 

199100100300000000  1.9.9.10.01.003-0   IPVA 
8.1.7.66.10.006-7   IPVA 

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nOme_cont LIKE '%Despesa%'

-- Adm. Variável  ---------------------------------
8.1.7.12.10.004-2	Nextel
8.1.7.57.10.007-6	Grafica
8.1.7.12.10.002-8	Telefone
8.1.7.12.10.001-1	Correio
8.1.7.57.10.008-3		Manutenção Veículo Despachante
--fim  Custo de Manutenção ************************

--  Custo de Cobrança  ************************  ABAIXO
--817571001300000000	8.1.7.57.10.013-1	Serviços de cobrança		 -- *************Custo de Cobrança
817571001300000000	8.1.7.57.10.013-1	Com. Cobrança  Custo de Cobrança -- *************Custo de Cobrança
817541001200000000	8.1.7.57.10.012-7	Com. Cobrança (Desc/ Shop/ Scm)  -- *************Custo de Cobrança
não utilizamos	??	Com. Cobrança Santana Factoring				-- *************Custo de Cobrança
8.1.7.57.10.051-9		Com. Cobrança Santana CFI - NF Promotora	-- *************Custo de Cobrança
8.1.7.57.10.999-8		Com. Cobrança Santana CFI - NF Promotora	-- *************Custo de Cobrança
8.1.7.99.10.024-7		Custas Processos Juridico  -- *************Custo de Cobrança
8.1.7.54.10.012-7	Custas Processos Juridico		-- *************Custo de Cobrança
--817631000200000000	8.1.7.63.10.002-2	Honorários advocatícios  --- ******** custo cobrança
817631000200000000	8.1.7.63.10.002-2	Honorarios advocaticios variaveis       --- ******** custo cobrança
8.1.7.63.10.015-6		Honorarios advocaticios variaveis  --- ****** ** custo cobrança

--fim  Custo de Cobrança ************************

-- margem de caixa  **********************************************************
7.1.5.10.10.005-8	Receita Aplicações
SELECT	MOV_D_C ,*
	FROM	GER_BASE_BALANCETE (NOLOCK)  	WHERE	DT_FECHA='20150430'  AND EMPRESA=99	
	AND CONTA in ('715101000500000000','714200000100000000','715102000100000000','715101003500000000','717991000100000000')

CONTA	CONTA_FMT	DESCR
714200000100000000	7.1.4.20.00.001-1	Rendas de CDI 
715101000500000000	7.1.5.10.10.005-8	Debentures 
715101003500000000	7.1.5.10.10.035-7	Letras de cambio 
715102000100000000	7.1.5.10.20.001-3	Aplicações de fundos de renda fixa

717991000100000000	7.1.7.99.10.001-3  tc desconto --  nao entra na margem!
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd ='7.1.7.99.10.001-3'

-- DESPESA ATRASO **********************************************************
BNDU
Provisão vendas de Bens	3	Diferença entre valor do carro e o valor de leilao	Despesa de Atraso


-- receita de aplicacoes
7.1.5.10.10.005-8  715101000500000000  Debentures 
7.1.4.20.00.001-1  714200000100000000  Rendas de CDI 
7.1.5.10.20.001-3  715102000100000000	Aplicações de fundos de renda fixa
7.1.5.10.10.035-7	715101003500000000  Letras de cambio



-- IMPOSTOS  **********************************************************
-- ir
894101000100000000  89410100016	8.9.4.10.10.001-6	IRPJ

894201000100000000 89420100013	8.9.4.20.10.001-3	CSLL  Contribuição social - valores correntes

819251000100000000 81925100011	8.1.9.25.10.001-1	ISS
8.1.7.69.20.002-9	ISS

--Crédito Tributário IR/CSLL
894103000100000000 8.9.4.10.30.001-2	Imposto de renda diferido -
894203000100000000 8.9.4.20.30.001-9 Contribuição social diferida -
SELECT	MOV_D_C ,*
	FROM	GER_BASE_BALANCETE (NOLOCK)  	WHERE	DT_FECHA='20150430'  AND EMPRESA=99	
	AND CONTA in ('894103000100000000','894203000100000000')

-- outras taxas
8.1.7.99.10.004-1		Contr Sind Patronal
tx jucesp
-- FIM IMPOSTOS  **********************************************************


select * from GER_BASE_BALANCETE (NOLOCK)  	WHERE	DT_FECHA='20150430'  AND
conta_fmt ='7.1.5.10.10.035-7'

	AND CONTA='811000000000000000'

DESPESAS PESSOAL SOMA DAS CONTAS

 81727-3

817270000000000000	8.1.7.27-3	DESPESAS DE PESSOAL - BENEFÍCIOS		-164.197,47 	 70.945,57 	 11.681,09 	-59.264,48 

                 81730-7
817300000000000000	8.1.7.30-7	DESPESAS DE PESSOAL - ENCARGOS SOCIAIS		-117.192,76 	 41.580,99 	 5.734,29 	-35.846,70 

               81733-4
817330000000000000	8.1.7.33-4	DESPESAS DE PESSOAL - PROVENTOS		-277.463,29 	 104.750,55 	 2.428,43 	-102.322,12 

               81737-0
817370000000000000	8.1.7.37-0	DESPESAS DE REMUNERAÇÃO DE ESTAGIÁRIOS		-8.347,35 	 1.818,82 	 -   	-1.818,82 

               8175710050 -2
817571005000000000	8.1.7.57.10.050-2	Prestação de Serviços de Terceiros		-453.376,91 	 160.876,09 	 -   	-160.876,09 

*/

-- DESPESAS PESSOAL ******************************************

DECLARE @DESPESA_TTL FLOAT

-- DECLARE @DTREF DATETIME SET @DTREF ='20150430'
--  DECLARE @DTREF DATETIME SET @DTREF ='20140131'

SET @DESPESA_TTL =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN 
--('817270000000000000','817300000000000000', '817330000000000000','817370000000000000','817571005000000000' ) )
('817331000300000000','817305000100000000','817301000100000000','817271000200000000','817271000300000000',
 '817271000100000000','817991001500000000','817571001400000000','817271000400000000',
 '817331000200000000','817271000500000000','817271000700000000','817331000500000000',
 '817331000300000000',	'839991001600000000',
 '817331000100000000','817371000100000000','839991001200000000','817331000400000000'))

/* AGO-15
--  PESSOAL	+ SERVICOS DE TERCEIROS 0.6
SET @DESPESA_TTL =	@DESPESA_TTL + 0.60 * (SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA   IN ('817571005000000000'))
*/
--  SET-15	 PESSOAL	+ SERVICOS DE TERCEIROS 100% 
SET @DESPESA_TTL =	@DESPESA_TTL +  (SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA   IN ('817571005000000000'))


DECLARE @DESPESA_VEIC FLOAT

SET @DESPESA_VEIC =@DESPESA_TTL / @CARTEIRA_TTL * @CARTEIRA_VEICULOS

--  SELECT @DESPESA_VEIC
-- VLR TABELADO NULL CONTRATOS ANTIGOS
-- SP_HELP DRE_ATRASO
UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.DESP_PESSOAL_SUP=   PROPORCAO_CARTEIRA * @DESPESA_VEIC
	WHERE	DT_FECHA = @DTREF


-- VARIAVEIS
DECLARE @DESPESA_CAD_TTL		FLOAT,
		@DESPESA_CAD_VEIC		FLOAT,
		@DESPESA_COML_TTL		FLOAT,
		@DESPESA_COML_VEIC		FLOAT,
		@CUSTO_MANUT_TTL		FLOAT,
		@CUSTO_MANUT_VEIC		FLOAT,
		@MARGEM_CAIXA_TTL		FLOAT,
		@MARGEM_CAIXA_VEIC		FLOAT,
		@CUSTO_COBRANCA_TTL		FLOAT,
		@CUSTO_COBRANCA_VEIC	FLOAT,
		@TRIBUTO_IRPJ_TTL		FLOAT,
		@TRIBUTO_IRPJ_VEIC		FLOAT,
		@TRIBUTO_CSSL_TTL		FLOAT,
		@TRIBUTO_CSSL_VEIC		FLOAT,
		@TRIBUTO_CRED_TRIB_TTL	FLOAT,
		@TRIBUTO_CRED_TRIB_VEIC	FLOAT,
		@TRIBUTO_OUTRAS_TXA_TTL	FLOAT,
		@TRIBUTO_OUTRAS_TXA_VEIC	FLOAT ,
@CM_TARIFAS_OUTRAS_RECEITA	FLOAT,		-- CUSTO MANUTENCAO
@CM_PROVISOES				FLOAT,
@CM_TARIFAS_DEPESA_OPER		FLOAT,
@CM_IMOBILIZADO				FLOAT,
@CM_DESP_PESSOAL			FLOAT,
@CM_DESP_DIRETORIA			FLOAT,
@CM_ALUGUEL					FLOAT,
@CM_ADM_FIXA				FLOAT,
@CM_ADM_VAR					FLOAT,
@CM_TARIFAS_OUTRAS_RECEITA_VEIC	FLOAT,		-- CUSTO MANUTENCAO SOMENTE VEIC
@CM_PROVISOES_VEIC				FLOAT,
@CM_TARIFAS_DEPESA_OPER_VEIC	FLOAT,
@CM_IMOBILIZADO_VEIC			FLOAT,
@CM_DESP_PESSOAL_VEIC			FLOAT,
@CM_DESP_DIRETORIA_VEIC			FLOAT,
@CM_ALUGUEL_VEIC				FLOAT,
@CM_ADM_FIXA_VEIC				FLOAT,
@CM_ADM_VAR_VEIC				FLOAT,
@CM_ADM_FIXA_CM				FLOAT,  -- CUSTO DE MANUT E CUSTO DE COBRA
@CM_ADM_FIXA_CC				FLOAT,
@CM_ADM_VAR_CM				FLOAT,					
@CM_ADM_VAR_CC				FLOAT,
@CM_ADM_FIXA_OUTRAS			FLOAT,
@CM_ADM_VAR_COMUNIC_VEIC	FLOAT,
@CM_ADM_FIXA_OUTRAS_veic	FLOAT


-- DESPESAS CADASTRO ******************************************
/*-- DESPESAS DE CADASTRO
817631000500000000	8.1.7.63.10.005-3		Associação Comercial (Boa Vista)
817541000100000000	8.1.7.54.10.001-7	Serviços de Digitalização / SAFEDOC
817631000700000000	8.1.7.63.10.007-7	Equifax
817631000800000000	8.1.7.63.10.008-4	SERASA
817541000100000000	8.1.7.54.10.001-7	Allcheck / Kontato / Crivo
817631000500000000	8.1.7.63.10.005-3	Associação Comercial (Boa Vista)
817631000900000000	8.1.7.63.10.009-1	FIPE / TH Consultas
817631001000000000	8.1.7.63.10.010-1	Gravame/Alienação CETIP
*/

SET @DESPESA_CAD_TTL =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('817631000500000000','817541000100000000', '817631000700000000','817631000800000000','817541000100000000' ,'817631000500000000','817631000900000000','817631001000000000') )
SET @DESPESA_CAD_VEIC =@DESPESA_CAD_TTL / @CARTEIRA_TTL * @CARTEIRA_VEICULOS


-- DESPESAS COMERCIAL   **********************************************************
/*
-- DESPESAS DE EQUIPE COMERCIAL
817661000100000000	8.1.7.66.10.001-2	Extra Area Comercial (Refeição/Alimento/Estacionamento...)  COMBUST??
817991000600000000  8.1.7.99.10.006-5   Refeições (Operadores)
817661001200000000  8.1.7.66.10.012-2	Estacionamento
Alimento ??  não utilizamos
839991000400000000 8.3.9.99.10.004-5	Big Prêmio / Prêmio Produção

817211000200000000 8.1.7.21.10.002-6	Reparos, adaptações e conservações

		@DESPESA_COML_TTL		FLOAT,
		@DESPESA_COML_VEIC		FLOAT,  

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.66.10.012-2','8.3.9.99.10.004-5','8.1.7.21.10.002-6')
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.66.10.001-2','8.3.9.99.10.004-5')

SELECT *	FROM	GER_BASE_BALANCETE (NOLOCK) 	WHERE	DT_FECHA='20150430' AND EMPRESA=99
		AND CONTA  IN ('817661000100000000','817991000600000000','817661001200000000', '839991000400000000','817211000200000000') 

*/

SET @DESPESA_COML_TTL =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('817661000100000000','817991000600000000','817661001200000000', '839991000400000000','817211000200000000') )

-- REFEICOES ESTA CONTA É DIVIDIDA COM COMERCIAL E ADM, SENDO APROXIMADAMENTE ( DIRETORIA 65%, COML 20% E 15% ADM)
SET @DESPESA_COML_TTL =	@DESPESA_COML_TTL + 0.2000*ISNULL((SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('817991000700000000' -- 8.1.7.99.10.007-2	Refeições    @CM_DESP_PESSOAL  RATEIO 0,65
							) ),0.0)
-- DESPESA COML VEIC PROPORCIONAL A CARTEIRA
SET @DESPESA_COML_VEIC =@DESPESA_COML_TTL / @CARTEIRA_TTL * @CARTEIRA_VEICULOS

-- CUSTO MANUTENCAO   **********************************************************
/*
		@CUSTO_MANUT_TTL		FLOAT,
		@CUSTO_MANUT_VEIC		FLOAT,
@CM_TARIFAS_OUTRAS_RECEITA	,		-- CUSTO MANUTENCAO

--	CM_TARIFAS_OUTRAS_RECEITA
717991001100000000 7.1.7.99.10.011-6	Tarifa Entrada de Titulos
717991000400000000 7.1.7.99.10.004-4	Tarifa Cartório
717991001200000000 7.1.7.99.10.012-3	Tarifa Prorrogação de Titulos
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '7.1.7.99.10.011-6','7.1.7.99.10.004-4','7.1.7.99.10.012-3')
*/
SET @CM_TARIFAS_OUTRAS_RECEITA =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('717991001100000000','717991000400000000', '717991001200000000') )
SET @CM_TARIFAS_OUTRAS_RECEITA_VEIC =@CM_TARIFAS_OUTRAS_RECEITA / @CARTEIRA_TTL * @CARTEIRA_VEICULOS

/*
@CM_TARIFAS_DEPESA_OPER		FLOAT,
-- CM  TARIFAS_DEPESA
817541000400000000	8.1.7.54.10.004-8		DOC's  
817541000300000000	8.1.7.54.10.003-1		CETIP
817571000500000000	8.1.7.57.10.005-2		Protestos/Cartório
817541000700000000	8.1.7.54.10.007-9		Tarifa Custodia Cheque			Tarifa de custódia
817541000600000000	8.1.7.54.10.006-2		Tarifa Carne/Duplicata
817541000900000000	8.1.7.54.10.009-3		Outras Tarifas Bancarias 
817541000800000000	8.1.7.54.10.008-6		Tarifa de Dep.Identificado
817541000500000000	8.1.7.54.10.005-5		Tarifa de TED
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nOme_cont LIKE '%Tarifa%'
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.54.10.004-8','8.1.7.57.10.005-2','8.1.7.54.10.006-2','8.1.7.54.10.009-3','8.1.7.54.10.008-6','8.1.7.54.10.005-5')
*/
SET @CM_TARIFAS_DEPESA_OPER =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ( '817541000400000000','817541000300000000', '817571000500000000','817541000700000000','817541000600000000','817541000900000000',
						'817541000800000000','817541000500000000') )
SET @CM_TARIFAS_DEPESA_OPER_VEIC =@CM_TARIFAS_DEPESA_OPER / @CARTEIRA_TTL * @CARTEIRA_VEICULOS


/*	CM
-- 10 - Total Despesas Imobilizado
818201000200000000	8.1.8.20.10.002-0	Depreciações
819992000700000000	8.1.9.99.20.007-1	Custo Obra CJJ   
@CM_IMOBILIZADO				,
@CM_DESP_PESSOAL			,
@CM_DESP_DIRETORIA			,
@CM_ALUGUEL					,
@CM_ADM_FIXA				,
@CM_ADM_VAR					
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.8.20.10.002-0','8.1.9.99.20.007-1')

*/

SET @CM_IMOBILIZADO =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('818201000200000000' ))
--,'819992000700000000')  NAO USAR CUSTO DE OBRA CJJ)
SET @CM_IMOBILIZADO_VEIC =@CM_IMOBILIZADO / @CARTEIRA_TTL * @CARTEIRA_VEICULOS

/*	CM  DESP_PESSOAL
-- CM  DESP_PESSOAL
@CM_DESP_PESSOAL			,
@CM_DESP_DIRETORIA			,
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.8.20.10.002-0','8.1.9.99.20.007-1')

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nOme_cont LIKE '%provis%'
817331000300000000	8.1.7.33.10.003-8	Salários
817305000100000000	8.1.7.30.50.001-9	Enc.INSS	8.1.7.30.50.001-9  nao usar na diretoria
817301000100000000	8.1.7.30.10.001-7	Enc.FGTS	8.1.7.30.10.001-7  nao usar na diretoria
817271000200000000	8.1.7.27.10.002-0	Vale refeição
817271000300000000	8.1.7.27.10.003-7	Vale Transporte
817271000100000000	8.1.7.27.10.001-3	Assist. Médica
817991001500000000	8.1.7.99.10.015-1	Desp.Pessoal
817571001400000000	8.1.7.57.10.014-8	Medicamentos
817271000400000000	8.1.7.27.10.004-4	Aux. Creche
817331000200000000	8.1.7.33.10.002-1	Férias
817271000500000000	8.1.7.27.10.005-1	Vale Alimentação
817271000700000000	8.1.7.27.10.007-5	Vale Cultura
817331000500000000	8.1.7.33.10.005-2	Indenizações

-- 817331000300000000	8.1.7.33.10.003-8	Resc. contrato	??
817371000100000000	8.1.7.37.10.001-0	IPP-estagiarios
839991001200000000	8.3.9.99.10.012-4	Bonificação PJ

-- NAO USAR CM DESP PESSOAL, ESTAH EM PROVISAO
817331000100000000	8.1.7.33.10.001-4	Provisão RH - (Férias, 13º, Rescisões)

817331000400000000	8.1.7.33.10.004-5	Provisão13o. Salario CLT - base Legal
-- 499305001500000000  4.9.9.30.50.015-0  Provisão para 13º - PJ  ??
839991001600000000	8.3.9.99.10.016-2	Provisão 13o. Salario PJ e Estagiarios

839991001300000000	8.3.9.99.10.013-1 Provisçao para PLR - CLT 

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.3.9.99.10.013-1','8.3.9.99.10.016-2')

servicos externos  não utilizamos

-- Salários inss
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.33.10.003-8','8.1.7.30.50.001-9')

-- vr
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.30.10.001-7','8.1.7.27.10.002-0')
--	Vale Transporte 	Assist. Médica
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.27.10.003-7','8.1.7.27.10.001-3')
--	Desp.Pessoal	Medicamentos
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.99.10.015-1','8.1.7.57.10.014-8')
--  Aux. Creche		Férias
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.27.10.004-4','8.1.7.33.10.002-1')
--	Vale Alimentação	Vale Cultura
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.27.10.005-1','8.1.7.27.10.007-5','8.1.7.33.10.005-2')
8.1.7.33.10.005-2	Indenizações

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.33.10.003-8','8.3.9.99.10.016-2')

--	Provisão RH - (Férias, 13º, Rescisões)	IPP-estagiarios	Bonificação PJ Bonificação PJ
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.33.10.001-4','8.1.7.37.10.001-0','8.3.9.99.10.012-4')
-- prov
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.33.10.004-5')
8.1.7.33.10.004-5	Provisão13o. Salario CLT - base Legal
499305001500000000  4.9.9.30.50.015-0  Provisão para 13º - PJ  ??


*/

SET @CM_DESP_PESSOAL =	(SELECT	SUM(MOV_DEB - MOV_CRED)  --  SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('817331000300000000','817305000100000000','817301000100000000','817271000200000000','817271000300000000',
'817271000100000000','817991001500000000','817571001400000000','817271000400000000',
'817331000200000000','817271000500000000','817271000700000000','817331000500000000',
'817331000300000000',  --'839991001600000000',
'817331000100000000','817371000100000000','839991001200000000','817331000400000000') )

IF DATEPART(MM, @DTREF) <> 12	-- OUTROS MESES
BEGIN
	-- PROVISAO NA CONTA CM PROVISAO	
	SET @CM_DESP_PESSOAL =	@CM_DESP_PESSOAL + ISNULL(
 		(SELECT	SUM(MOV_DEB - MOV_CRED) 	FROM	GER_BASE_BALANCETE (NOLOCK) 
		WHERE	DT_FECHA=@DTREF AND EMPRESA=99 		AND CONTA  IN ('839991001600000000', '839991001300000000')),0.0)
/* AGO-15
	--  DIRETORIA +  SERVICOS DE TERCEIROS 0.6   + 0.2 DIRETORIA + 0.2 INFORMATICA
	SET @CM_DESP_PESSOAL =	@CM_DESP_PESSOAL + 0.60 * (SELECT	SUM(MOV_D_C)
		FROM	GER_BASE_BALANCETE (NOLOCK) 
		WHERE	DT_FECHA=@DTREF AND EMPRESA=99
			AND CONTA   IN ('817571005000000000'))
*/
	--  SET-15	ALTEREI P/ JOGAR 100% DESPESA SVCO 3os NA CM_DESP_PESSOAL  TODOS CM
	SET @CM_DESP_PESSOAL =	@CM_DESP_PESSOAL +  (SELECT	SUM(MOV_D_C)
		FROM	GER_BASE_BALANCETE (NOLOCK) 
		WHERE	DT_FECHA=@DTREF AND EMPRESA=99
			AND CONTA   IN ('817571005000000000'))
END

-- AJUSTE DE PROVISOES EM DEZ DE CADA ANO. BALANCETE ZERA PROVISOES.  ************* TRATA EXCECAO
IF DATEPART(MM, @DTREF) = 12	-- DEZ
BEGIN
	SET @CM_DESP_PESSOAL =	@CM_DESP_PESSOAL + ISNULL(
 		(SELECT	SUM(MOV_DEB * (-1.0)) 	FROM	GER_BASE_BALANCETE (NOLOCK) 
		WHERE	DT_FECHA=@DTREF AND EMPRESA=99 		AND CONTA  IN ('839991001600000000', '839991001300000000')),0.0)

	--  DIRETORIA +  SERVICOS DE TERCEIROS 0.3   + 0.4 DIRETORIA + 0.4 INFORMATICA
/* AGO-15
	SET @CM_DESP_PESSOAL =	@CM_DESP_PESSOAL + 0.30 * (SELECT	SUM(MOV_D_C)
		FROM	GER_BASE_BALANCETE (NOLOCK) 
		WHERE	DT_FECHA=@DTREF AND EMPRESA=99
			AND CONTA   IN ('817571005000000000'))
*/
	--  SET-15	ALTEREI P/ JOGAR 100% DESPESA SVCO 3os NA CM_DESP_PESSOAL  TODOS CM
	SET @CM_DESP_PESSOAL =	@CM_DESP_PESSOAL + (SELECT	SUM(MOV_D_C)
		FROM	GER_BASE_BALANCETE (NOLOCK) 
		WHERE	DT_FECHA=@DTREF AND EMPRESA=99
			AND CONTA   IN ('817571005000000000'))
END


-- REFEICOES ESTA CONTA É DIVIDIDA COM COMERCIAL E ADM, SENDO APROXIMADAMENTE ( DIRETORIA 65%, COML 20% E 15% ADM)
SET @CM_DESP_PESSOAL =	@CM_DESP_PESSOAL + 0.1500*ISNULL((SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN (
'817991000700000000' -- 8.1.7.99.10.007-2	Refeições    @CM_DESP_PESSOAL  RATEIO 0,65
  ) ),0.0)

SET @CM_DESP_PESSOAL_VEIC =@CM_DESP_PESSOAL / @CARTEIRA_TTL * @CARTEIRA_VEICULOS

/*
-- CM  PROVISAO
817331000100000000	8.1.7.33.10.001-4	Provisão RH - (Férias, 13º, Rescisões)
817331000400000000	8.1.7.33.10.004-5	Provisão13o. Salario CLT - base Legal
839991001600000000	8.3.9.99.10.016-2	Provisão 13o. Salario PJ e Estagiarios
817991002100000000   8.1.7.99.10.021-6  Acordos e ações judiciais

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nOme_cont LIKE '%PROVIS%'
@CM_PROVISOES				,
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.33.10.001-4','8.1.7.33.10.004-5','8.3.9.99.10.016-2')
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.99.10.021-6')
*/

SET @CM_PROVISOES =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('817331000100000000','817331000400000000', '817991002100000000') )
-- '839991001600000000',

IF DATEPART(MM, @DTREF) <> 12	-- OUTROS MESES
BEGIN
	-- PROVISAO NA CONTA CM PROVISAO	
	SET @CM_PROVISOES =	@CM_PROVISOES + ISNULL(
 		(SELECT	SUM(MOV_DEB - MOV_CRED) 	FROM	GER_BASE_BALANCETE (NOLOCK) 
		WHERE	DT_FECHA=@DTREF AND EMPRESA=99 		AND CONTA  IN ('839991001600000000', '839991001300000000')),0.0)
END

-- AJUSTE DE PROVISOES EM DEZ DE CADA ANO. BALANCETE ZERA PROVISOES.  ************* TRATA EXCECAO
IF DATEPART(MM, @DTREF) = 12	-- DEZ
BEGIN
	SET @CM_PROVISOES =	@CM_PROVISOES + ISNULL(
 		(SELECT	SUM(MOV_DEB * (-1.0)) 	FROM	GER_BASE_BALANCETE (NOLOCK) 
		WHERE	DT_FECHA=@DTREF AND EMPRESA=99 		AND CONTA  IN ('839991001600000000', '839991001300000000')),0.0)
END


SET @CM_PROVISOES_VEIC =@CM_PROVISOES / @CARTEIRA_TTL * @CARTEIRA_VEICULOS



/*	CM  DESP_DIRETORIA
-- CM  DESP_DIRETORIA
-- 2 - Total Diretoria  ----------------------
188050200300000000	1.8.8.05.02.003-3	Pró-labore
188050200100000000	1.8.8.05.02.001-9	Pró-labore
817511000300000000	8.1.7.51.10.003-4		Seguros
	não utilizamos	Seminarios Diretoria		??
817511000500000000	8.1.7.51.10.005-8		Assist. Médica Diretoria
	não utilizamos	INSS				?? no desp Pessoal
817301000100000000 8.1.7.30.10.001-7	Enc.FGTS  diretoria??  no desp Pessoal, nao usar no diretoria
8.1.7.30.50.001-9	Enc.INSS  diretoria??   no desp Pessoal, nao usar no diretoria

817661000600000000 8.1.7.66.10.006-7	IPVA
817661000500000000 8.1.7.66.10.005-0	Manuntenção Veiculos 
817991000700000000 8.1.7.99.10.007-2	Refeições    DIRETORIA ??
ESTÁ CONTA É DIVIDIDA COM COMERCIAL E ADM, SENDO APROXIMADAMENTE ( DIRETORIA 65%, COML 20% E 15% ADM)

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '1.8.8.05.02.003-3','1.8.8.05.02.001-9','8.1.7.51.10.003-4')
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.51.10.005-8','8.1.7.30.10.001-7','8.1.7.30.50.001-9')
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.66.10.006-7','8.1.7.66.10.005-0','8.1.7.99.10.007-2')

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nOme_cont LIKE '%provis%'
817305000100000000
*/

SET @CM_DESP_DIRETORIA =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('817511000300000000','817511000500000000' , -- seguros		Assist. Médica Diretoria
'817661000600000000','817661000500000000'   ) )	--	IPVA  8.1.7.66.10.005-0	Manuntenção Veiculos 

-- 188050200100000000 JOAO, 188050200300000000 JR
IF  DATEPART(MM,@DTREF) <> 12  -- OUTROS MESES MOV DC
BEGIN
	SET @CM_DESP_DIRETORIA =	@CM_DESP_DIRETORIA + ISNULL((SELECT	SUM(MOV_D_C)
		FROM	GER_BASE_BALANCETE (NOLOCK) 
		WHERE	DT_FECHA=@DTREF AND EMPRESA=99
			AND CONTA  IN ('188050200300000000','188050200100000000')),0.0)
END
-- TRATA DIFERENTE EM DEZ ZERA BALANCETE
IF  DATEPART(MM,@DTREF) = 12  -- DEZ SOMENTE MOV_DEB
BEGIN
	SET @CM_DESP_DIRETORIA =	@CM_DESP_DIRETORIA + ISNULL((SELECT	SUM(MOV_DEB)
		FROM	GER_BASE_BALANCETE (NOLOCK) 
		WHERE	DT_FECHA=@DTREF AND EMPRESA=99
			AND CONTA  IN ('188050200300000000','188050200100000000')),0.0)
END

SET @CM_DESP_DIRETORIA =	@CM_DESP_DIRETORIA + 0.6500*ISNULL((SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('817991000700000000' -- 8.1.7.99.10.007-2	Refeições    DIRETORIA RATEIO 0,65
  ) ),0.0)

/*
AGO-15
--  DIRETORIA +  SERVICOS DE TERCEIROS 0.2 , 0.6 PESSOAL, 0.2 INFORMATICA
SET-15		100% NO PESSOAL
SET @CM_DESP_DIRETORIA =	@CM_DESP_DIRETORIA + 0.20 * (SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA   IN ('817571005000000000'))
*/

-- notas = pro labore

SET @CM_DESP_DIRETORIA_VEIC =@CM_DESP_DIRETORIA / @CARTEIRA_TTL * @CARTEIRA_VEICULOS

/*
@CM_ALUGUEL					
-- Despesa com Aluguel 25 em abr-15
817061000100000000	8.1.7.06.10.001-0		Aluguel CJJ  25K sede
817991000200000000	8.1.7.99.10.002-7	Aluguel prédio
Aluguel Sala Shop		?? ja deve estar entre os 4 alugueis...
817000000000000000   8.1.7-6	DESPESAS ADMINISTRATIVAS
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.99.10.002-7','8.1.7.06.10.001-0')

@CM_ALUGUEL					,
@CM_ADM_FIXA				,
@CM_ADM_VAR					,
@CM_ADM_FIXA_CM				FLOAT,  -- CUSTO DE MANUT E CUSTO DE COBRA
@CM_ADM_FIXA_CC				FLOAT,
@CM_ADM_VAR_CM				FLOAT,					
@CM_ADM_VAR_CC				FLOAT

*/

SET @CM_ALUGUEL =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('817061000100000000' ))
--'817061000100000000','817991000200000000','817000000000000000'    ) )

SET @CM_ALUGUEL_VEIC =@CM_ALUGUEL / @CARTEIRA_TTL * @CARTEIRA_VEICULOS

/*
@CM_ADM_FIXA				,
@CM_ADM_FIXA_CM				FLOAT,  -- CUSTO DE MANUT E CUSTO DE COBRA
@CM_ADM_FIXA_CC				FLOAT,
--Adm. Fixa			---------------------------------

817031000200000000	8.1.7.03.10.002-0	Água
817061000100000000	8.1.7.99.10.002-7	Aluguel prédio
817991000200000000	8.1.7.06.10.001-0	Aluguel CJJ  CONDOMIN
Aluguel Sala Filial
817692000100000000	8.1.7.69.20.001-2   IPTU

817061000000000000  8.1.7.06.10-3 DESPESAS DE ALUGUÉIS  ??
817061000000000000  8.1.7.06.10-3 DESPESAS DE ALUGUÉIS  ?? NAO USAR CTA TOTALIZADORA COM ALUGUEL EQUIP
817061000100000000	8.1.7.06.10.001-0	Aluguel de imóveis ??
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.03.10.002-0',
'8.1.7.99.10.002-7','8.1.7.06.10.001-0','8.1.7.69.20.001-2')
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd >='8.1.7.03.10.002-0'

817030000000000000	8.1.7.03-3	DESPESAS DE ÁGUA, ENERGIA E GÁS
817692000100000000	8.1.7.69.20.001-2		IPTU
817031000100000000	8.1.7.03.10.001-3		Luz

817571005000000000	8.1.7.57.10.050-2	Marcas e Dominios		
					8.1.7.57.10.050-2	Prestação de Serviços de Terceiros NAO SOMAR


817571001100000000	8.1.7.57.10.011-7	Arquivo Terceirizado - Iron Mountain 
817631000600000000	8.1.7.63.10.006-0	Assessoria Técnica - MK
817391000800000000	8.1.7.39.10.008-7	Auditoria e Gerenciamento de Riscos - Finaud - RSM

817391001100000000	8.1.7.39.10.011-1	Banco Central - Sisbacen - RTM
817631001200000000	8.1.7.63.10.012-5	Consultoria Orçamento / MSCI / BESS / FONTES		
817631000200000000	8.1.7.63.10.002-2	Honorario Advocatícios - Fixo    -- custo de cobrança?? ***********

817571000900000000	8.1.7.57.10.009-0	Limpeza / Portaria - Visa Clean
817061000200000000	8.1.7.06.10.002-7	Locação Xerox / Impressoras - FM
817391000100000000	8.1.7.39.10.001-8	Manutenção Informatica (Estrutura) - Onne 

817661001000000000	8.1.7.66.10.010-8	Motoboy - Coty Motors
817391001000000000	8.1.7.39.10.010-4	Serviços de RH (Depto. Pessoal) - Pay System
817571001400000000	8.1.7.57.10.014-8	Serviços de RH (Testes/Laudos/RH Bancos)

817601000100000000	8.1.7.60.10.001-8	Serviços de Segurança - Mult Acess
817391000200000000	8.1.7.39.10.002-5	Sistemas Inf. (CDC/FIFA) - Função Inf / ATT
817391000500000000	8.1.7.39.10.005-6	Sistemas Inf. (Financeiro/Contábil) CFI - ZAP

INCLUI
'817631000200000000' 8.1.7.63.10.002-2	Honorario Advocatícios - Fixo    -- custo CM ADM FIXO***********
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.69.20.001-2','8.1.7.03.10.001-3','8.1.7.57.10.050-2')
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.57.10.011-7','8.1.7.63.10.006-0','8.1.7.39.10.008-7')
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.39.10.011-1','8.1.7.63.10.012-5','8.1.7.63.10.002-2')
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.57.10.009-0','8.1.7.06.10.002-7','8.1.7.39.10.001-8')
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.66.10.010-8','8.1.7.39.10.010-4','8.1.7.57.10.014-8')
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.60.10.001-8','8.1.7.39.10.002-5','8.1.7.39.10.005-6')

8.1.7.57.10.050-2

@CM_ADM_VAR					,

*/
-- ALUGUEL, AGUA, IPTU, CONDOMINIO
SET @CM_ADM_FIXA_CM = ISNULL(@CM_ADM_FIXA_CM,0.0) +	ISNULL((SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('817031000200000000','817061000100000000','817991000200000000',
'817692000100000000')),0.0)

SET @CM_ADM_FIXA_CM =	ISNULL(@CM_ADM_FIXA_CM,0.0)+ISNULL((SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('817030000000000000','817692000100000000','817031000100000000',
--'817571005000000000',  NAO USAR Prestação de Serviços de Terceiros  160 K, ESTA EM PESSOAL CM
  
'817571001100000000', --	8.1.7.57.10.011-7	Arquivo Terceirizado - Iron Mountain 
'817631000600000000', --	8.1.7.63.10.006-0	Assessoria Técnica - MK
'817391000800000000', --	8.1.7.39.10.008-7	Auditoria e Gerenciamento de Riscos - Finaud - RSM

'817391001100000000', --	8.1.7.39.10.011-1	Banco Central - Sisbacen - RTM
'817631001200000000', --	8.1.7.63.10.012-5	Consultoria Orçamento / MSCI / BESS / FONTES		
'817571000900000000', --	8.1.7.57.10.009-0	Limpeza / Portaria - Visa Clean
'817061000200000000', --	8.1.7.06.10.002-7	Locação Xerox / Impressoras - FM
'817391000100000000', --	8.1.7.39.10.001-8	Manutenção Informatica (Estrutura) - Onne 

'817661001000000000', --	8.1.7.66.10.010-8	Motoboy - Coty Motors
'817391001000000000', --	8.1.7.39.10.010-4	Serviços de RH (Depto. Pessoal) - Pay System
'817571001400000000', --	8.1.7.57.10.014-8	Serviços de RH (Testes/Laudos/RH Bancos)

'817601000100000000', --	8.1.7.60.10.001-8	Serviços de Segurança - Mult Acess
'817391000200000000', --	8.1.7.39.10.002-5	Sistemas Inf. (CDC/FIFA) - Função Inf / ATT
'817391000500000000',  --	8.1.7.39.10.005-6	Sistemas Inf. (Financeiro/Contábil) CFI - ZAP
'817631000200000000' --	8.1.7.63.10.002-2	Honorario Advocatícios - Fixo    -- custo CM ADM FIXO***********
    ) ),0.0)

		-- CUSTO COBRANCA
SET @CM_ADM_FIXA_CC =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('817631000200000000' --	8.1.7.63.10.002-2	Honorario Advocatícios - Fixo    -- custo de cobrança?? ***********
   ) )

		-- CUSTO MANUTENCAO  +  SERVICOS DE TERCEIROS 0.6 PESSOAL   + 0.2 DIRETORIA + 0.2 INFORMATICA
/* AGO-15
SET @CM_ADM_FIXA_CM =	@CM_ADM_FIXA_CM + 0.20 * (SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA   IN ('817571005000000000'))
SET-15 100% NA DESPESA DE PESSOAL CM
*/

SET @CM_ADM_FIXA =(@CM_ADM_FIXA_CM + @CM_ADM_FIXA_CC) 
SET @CM_ADM_FIXA_VEIC =(@CM_ADM_FIXA_CM + @CM_ADM_FIXA_CC) / @CARTEIRA_TTL * @CARTEIRA_VEICULOS

/*
-- CM @CM_ADM_FIXA_OUTRAS			FLOAT
-- sub ttl 2
817991000900000000	8.1.7.99.10.009-6	ACREFI
	ANFAC n
	ANEPS n
	Sebrae / ABSCM ??
-- sub ttl 3
817991001400000000	8.1.7.99.10.014-4	Copa/Cozinha
817991000700000000	8.1.7.99.10.007-2	Refeições
8.1.7.66.10.001-2	Combustível   ??
817661000300000000	8.1.7.66.10.003-6	Condução
817661001200000000	8.1.7.66.10.012-2	Estacionamento
não utilizamos	Serviços Externos  ??
839991000700000000	8.3.9.99.10.007-6	Publicação de Balanço / ATA Diretoria
817451000200000000	8.1.7.45.10.002-6	Publicação de Balanço / ATA Diretoria

817121000300000000	8.1.7.12.10.003-5	Internet-Sites/e-Mails
não utilizamos	Visimax - Radar  ??
não utilizamos	API - Consultas Telefone  ??
817241000200000000	8.1.7.24.10.002-3	Material  Escritório
não utilizamos	Xerox Cópias		??
não utilizamos	Certidões/Firmas/Autenticação	??
817991002400000000	8.1.7.99.10.024-7	Custas Processos Juridico
817541001200000000	8.1.7.54.10.012-7	Custas Processos Juridico

817421000100000000	8.1.7.42.10.001-2	Brindes
não utilizamos	Anuncios		??
não utilizamos	PPRA/PCMSO		??
817571001500000000	8.1.7.57.10.015-5  Seguros  MONITOR
817511000300000000	8.1.7.51.10.003-4   Seguros VEIC
817271000600000000	8.1.7.27.10.006-8  Seguros de VIda ??

	Conservação Predio - CJJ   ??
817421000300000000	8.1.7.42.10.003-6	Doações LEI ROUANET
817151000100000000	8.1.7.15.10.001-8	Doações FILANTROP
	Eventuais			??
817991000900000000	8.1.7.99.10.009-6	Entidade de Classes

817991000100000000	8.1.7.99.10.001-0	Jornais/Revistas
817451000200000000	8.1.7.45.10.002-6	Marketing
817451000100000000	8.1.7.45.10.001-9	Marketing
	MKT - impresso/Foto		OK  ?
	Despesas CJJ		??
817991000800000000	8.1.7.99.10.008-9	Multa e Juros   de contas gerais
817991001100000000	8.1.7.99.10.011-3	Multa e Juros
817541001200000000	8.1.7.54.10.012-7	Multa e Juros  ??

@CM_ADM_FIXA_OUTRAS			FLOAT
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.99.10.009-6','8.1.7.99.10.007-2','8.1.7.66.10.003-6')
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.66.10.012-2','8.3.9.99.10.007-6','8.1.7.45.10.002-6')

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.12.10.003-5',  '8.1.7.24.10.002-3','8.1.7.99.10.024-7','8.1.7.54.10.012-7')
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.42.10.001-2',  '8.1.7.57.10.015-5','8.1.7.51.10.003-4','8.1.7.27.10.006-8')

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.42.10.003-6',  '8.1.7.15.10.001-8','8.1.7.99.10.009-6')
-- JORNAIS MKT
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.99.10.001-0',  '8.1.7.45.10.002-6','8.1.7.45.10.001-9')

-- 	MULTA JR
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.99.10.008-9',  '8.1.7.99.10.011-3','8.1.7.54.10.012-7')


*/

SET @CM_ADM_FIXA_OUTRAS =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN (
'817991000900000000', --	8.1.7.99.10.009-6	ACREFI
/*	ANFAC n
	ANEPS n
	Sebrae / ABSCM ??		*/
-- sub ttl 3
'817991001400000000', --	8.1.7.99.10.014-4	Copa/Cozinha
'817991000700000000', --	8.1.7.99.10.007-2	Refeições
--	Combustível   ??
'817661000300000000', --	8.1.7.66.10.003-6	Condução
'817661001200000000', --	8.1.7.66.10.012-2	Estacionamento
--	Serviços Externos  ??
'839991000700000000', --	8.3.9.99.10.007-6	Publicação de Balanço / ATA Diretoria
'817451000200000000', --	8.1.7.45.10.002-6	Publicação de Balanço / ATA Diretoria

'817121000300000000', --	8.1.7.12.10.003-5	Internet-Sites/e-Mails
--	Visimax - Radar  ??
--	API - Consultas Telefone  ??
'817241000200000000', --	8.1.7.24.10.002-3	Material  Escritório
/*	Xerox Cópias		??
	Certidões/Firmas/Autenticação	??		*/
'817991002400000000', --	8.1.7.99.10.024-7	Custas Processos Juridico
'817541001200000000', --	8.1.7.54.10.012-7	Custas Processos Juridico

'817421000100000000', --	8.1.7.42.10.001-2	Brindes
--	Anuncios		??
--	PPRA/PCMSO		??
'817571001500000000', --	8.1.7.57.10.015-5  Seguros  MONITOR
'817511000300000000', --	8.1.7.51.10.003-4   Seguros VEIC
'817271000600000000', --	8.1.7.27.10.006-8  Seguros de VIda ??

--	Conservação Predio - CJJ   ??
'817421000300000000', --	8.1.7.42.10.003-6	Doações LEI ROUANET
'817151000100000000', --	8.1.7.15.10.001-8	Doações FILANTROP
--	Eventuais			??
'817991000900000000', --	8.1.7.99.10.009-6	Entidade de Classes

'817991000100000000', --	8.1.7.99.10.001-0	Jornais/Revistas
'817451000200000000', --	8.1.7.45.10.002-6	Marketing
'817451000100000000', --	8.1.7.45.10.001-9	Marketing
--	MKT - impresso/Foto		OK  ?
--	Despesas CJJ		??
'817991000800000000', --	8.1.7.99.10.008-9	Multa e Juros   de contas gerais
'817991001100000000', --	8.1.7.99.10.011-3	Multa e Juros
'817541001200000000'  --	8.1.7.54.10.012-7	Multa e Juros  ??

   ) )

SET @CM_ADM_FIXA_VEIC =(@CM_ADM_FIXA_CM + @CM_ADM_FIXA_CC +@CM_ADM_FIXA_OUTRAS) / @CARTEIRA_TTL * @CARTEIRA_VEICULOS

/*  CM
-- Adm. Variável  ---------------------------------
817121000400000000	8.1.7.12.10.004-2	Nextel
817571000700000000	8.1.7.57.10.007-6	Grafica
817121000200000000	8.1.7.12.10.002-8	Telefone
817121000100000000	8.1.7.12.10.001-1	Correio
817571000800000000	8.1.7.57.10.008-3	Manutenção Veículo Despachante

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.12.10.004-2','8.1.7.57.10.007-6','8.1.7.12.10.002-8','8.1.7.12.10.001-1','8.1.7.57.10.008-3')

@CM_ADM_VAR
*/
SET @CM_ADM_VAR =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('817121000400000000', '817571000700000000', '817121000200000000','817121000100000000','817571000800000000'))
-- ???????
 SET @CM_ADM_VAR_VEIC =(@CM_ADM_VAR) / @CARTEIRA_TTL * @CARTEIRA_VEICULOS

-- FIM  CUSTO MANUTENCAO   **********************************************************



-- CUSTO COBRANCA   **********************************************************
--  Custo de Cobrança  ************************
/*
SP_HELP DRE_SEM_VEIC
817571001300000000	8.1.7.57.10.013-1	Com. Cobrança  Custo de Cobrança -- *************Custo de Cobrança
817541001200000000	8.1.7.57.10.012-7	Com. Cobrança (Desc/ Shop/ Scm)  -- *************Custo de Cobrança
não utilizamos	??	Com. Cobrança Santana Factoring				-- *************Custo de Cobrança
817571005100000000	8.1.7.57.10.051-9		Com. Cobrança Santana CFI - NF Promotora	-- *************Custo de Cobrança
817571099900000000	8.1.7.57.10.999-8		Com. Cobrança Santana CFI - NF Promotora	-- *************Custo de Cobrança
817991002400000000	8.1.7.99.10.024-7		Custas Processos Juridico  -- *************Custo de Cobrança
817541001200000000	8.1.7.54.10.012-7	Custas Processos Juridico		-- *************Custo de Cobrança
--817631000200000000	8.1.7.63.10.002-2	Honorários advocatícios  --- ******** custo cobrança
817631000200000000	8.1.7.63.10.002-2	Honorarios advocaticios variaveis       --- ******** custo cobrança
817631001500000000	8.1.7.63.10.015-6		Honorarios advocaticios variaveis  --- ****** ** custo cobrança

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.57.10.012-7','8.1.7.57.10.051-9','8.1.7.57.10.999-8',
'8.1.7.99.10.024-7','8.1.7.54.10.012-7','8.1.7.63.10.015-6')

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.57.10.012-4', '8.1.7.57.10.013-1')
		@CUSTO_COBRANCA_TTL		FLOAT,
		@CUSTO_COBRANCA_VEIC	FLOAT,
*/
SET @CUSTO_COBRANCA_TTL =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN (

/*
-- ******* REMOVI P/ TESTE 2-SET-2015  
-- 2014  
'817571001300000000',	--	8.1.7.57.10.012-4	Com. Cobrança  Custo de Cobrança -- *************Custo de Cobrança SVC COBR
'817541001200000000',	--	8.1.7.57.10.013-1	Com. Cobrança (Desc/ Shop/ Scm)  -- *************Custo de Cobrança RETORNO
--	??	Com. Cobrança Santana Factoring				-- *************Custo de Cobrança

 '817571005100000000',	--	8.1.7.57.10.051-9		Com. Cobrança Santana CFI - NF Promotora	-- *************Custo de Cobrança
 '817571099900000000',	--	8.1.7.57.10.999-8		Com. Cobrança Santana CFI - NF Promotora	-- *************Custo de Cobrança
-- ******* FIM    REMOVI P/ TESTE 2-SET-2015
*/

'817991002400000000',	--	8.1.7.99.10.024-7		Custas Processos Juridico  -- *************Custo de Cobrança
'817541001200000000',	--	8.1.7.54.10.012-7	Custas Processos Juridico		-- *************Custo de Cobrança
--817631000200000000	8.1.7.63.10.002-2	Honorários advocatícios  --- ******** custo cobrança  EM CM_CC
'817631000200000000',	--	8.1.7.63.10.002-2	Honorarios advocaticios variaveis       --- ******** custo cobrança
'817631001500000000'	--	8.1.7.63.10.015-6		Honorarios advocaticios variaveis  --- ****** ** custo cobrança
) )

-- DECLARE @DTREF DATETIME SET @DTREF ='20150430'
--  7.1.7.99.10.007-5	Com. Cobrança SCM  717991000700000000 Serviços de cobrança
-- select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '7.1.7.99.10.007-5')
/*SET @CUSTO_COBRANCA_TTL =	ISNULL(@CUSTO_COBRANCA_TTL,0.0) - ISNULL((SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('717991000700000000') ),0.0) -- RECEITA ATRASO COBRANCA NOTA SHOP
*/
SET @CUSTO_COBRANCA_VEIC =(@CUSTO_COBRANCA_TTL+ @CM_ADM_FIXA_CC) / @CARTEIRA_TTL * @CARTEIRA_VEICULOS

--fim  Custo de Cobrança ************************
-- FIM  CUSTO COBRANCA   **********************************************************





-- MARGEM CAIXA  **********************************************************
/*
-- margem de caixa  **********************************************************
SELECT	MOV_D_C ,*
	FROM	GER_BASE_BALANCETE (NOLOCK)  	WHERE	DT_FECHA='20150430'  AND EMPRESA=99	
	AND CONTA in ('715101000500000000','714200000100000000','715102000100000000','715101003500000000')
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.1.85.10.001-9','8.1.1.30.00.002-3')

CONTA	CONTA_FMT	DESCR
714200000100000000	7.1.4.20.00.001-1	Rendas de CDI 
715101000500000000	7.1.5.10.10.005-8	Debentures		Receita Aplicações
715101003500000000	7.1.5.10.10.035-7	Letras de cambio 
715102000100000000	7.1.5.10.20.001-3	Aplicações de fundos de renda fixa
DESPESAS
811851000100000000	8.1.1.85.10.001-9	Contribuição ordinária 
811300000200000000	8.1.1.30.00.002-3	Despesa de Captação DPGE2
*/

-- aplicacao sldo de caixa
SET @MARGEM_CAIXA_TTL =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('714200000100000000','715101000500000000', '715101003500000000','715102000100000000') )

IF DATEPART(YYYY, @DTREF) >=  2015  -- apos 2015
	BEGIN
		SET	@MARGEM_CAIXA_TTL =	 @MARGEM_CAIXA_TTL - ISNULL((SELECT	SUM(MOV_D_C)
										FROM	GER_BASE_BALANCETE (NOLOCK) 
										WHERE	DT_FECHA=@DTREF AND EMPRESA=99   -- DESPESA DE CAPTACAO
											AND CONTA IN ('811300000100000000')),0.0) -- CONTAS DPGE 1 somente (/ 2 E 2  )
	END
ELSE
begin
-- AJUSTE 2014 CUSTO DE CAPTACAO 1 CONTA. PROPORCAO 2  jan/14 , ago/14 , set/14
IF CONVERT(VARCHAR(4),DATEPART(YYYY, @DTREF))+'-'+ RIGHT('00'+LTRIM(CONVERT(VARCHAR(2),DATEPART(MM, @DTREF))),2) 
	IN (  '2014-08' , '2014-09')
	BEGIN
		SET	@MARGEM_CAIXA_TTL =	 @MARGEM_CAIXA_TTL - ISNULL((SELECT	SUM(MOV_D_C)
										FROM	GER_BASE_BALANCETE (NOLOCK) 
										WHERE	DT_FECHA=@DTREF AND EMPRESA=99   -- DESPESA DE CAPTACAO
											AND CONTA IN ('811300000100000000')),0.0)/2.0 -- DIVIDE POR 2: CONTAS DPGE 1/ 2 E 2  
	END
ELSE

	IF CONVERT(VARCHAR(4),DATEPART(YYYY, @DTREF))+'-'+ RIGHT('00'+LTRIM(CONVERT(VARCHAR(2),DATEPART(MM, @DTREF))),2) 
		IN ( '2014-01')
		BEGIN
			SET	@MARGEM_CAIXA_TTL =	 @MARGEM_CAIXA_TTL - ISNULL((SELECT	SUM(MOV_D_C)
											FROM	GER_BASE_BALANCETE (NOLOCK) 
											WHERE	DT_FECHA=@DTREF AND EMPRESA=99   -- DESPESA DE CAPTACAO
												AND CONTA IN ('811300000100000000')),0.0)/3.0 -- DIVIDE POR 2: CONTAS DPGE 1/ 2 E 2  
		END
	ELSE
	begin
		--	2014-10-31 00:00:00.000, 2014-11-30 00:00:00.000, 2014-12-31 00:00:00.000
			IF CONVERT(VARCHAR(4),DATEPART(YYYY, @DTREF))+'-'+ RIGHT('00'+LTRIM(CONVERT(VARCHAR(2),DATEPART(MM, @DTREF))),2) 
				IN ( '2014-10', '2014-11' , '2014-12')
				BEGIN
					SET	@MARGEM_CAIXA_TTL =	 @MARGEM_CAIXA_TTL - ISNULL((SELECT	SUM(MOV_D_C)
													FROM	GER_BASE_BALANCETE (NOLOCK) 
													WHERE	DT_FECHA=@DTREF AND EMPRESA=99   -- DESPESA DE CAPTACAO
														AND CONTA IN ('811300000100000000')),0.0)*0.80 -- RATEIA: CONTA DPGE 1
				END
			ELSE
			BEGIN
				BEGIN
					-- AJUSTE 2013 CUSTO DE CAPTACAO 1 CONTA. PASSA A SER 2 CONTAS A PARTIR DE OUT-14
					IF CONVERT(VARCHAR(4),DATEPART(YYYY, @DTREF))+'-'+ RIGHT('00'+LTRIM(CONVERT(VARCHAR(2),DATEPART(MM, @DTREF))),2) <= '2014-09'
						BEGIN
							SET	@MARGEM_CAIXA_TTL =	 @MARGEM_CAIXA_TTL - ISNULL((SELECT	SUM(MOV_D_C)
															FROM	GER_BASE_BALANCETE (NOLOCK) 
															WHERE	DT_FECHA=@DTREF AND EMPRESA=99   -- DESPESA DE CAPTACAO
																AND CONTA IN ('811300000100000000')),0.0)/4.0 -- DIVIDE POR 2: CONTAS DPGE 1/ 2 E 2  
						END
					ELSE
						BEGIN
							SET	@MARGEM_CAIXA_TTL =	 @MARGEM_CAIXA_TTL - ISNULL((SELECT	SUM(MOV_D_C)
															FROM	GER_BASE_BALANCETE (NOLOCK) 
															WHERE	DT_FECHA=@DTREF AND EMPRESA=99   -- DESPESA DE CAPTACAO PARCIAL
																AND CONTA IN ('811300000100000000')),0.0)/2.0  
						END
				END
			END
	end
end
-- Despesa de Captação DPGE
--'811851000100000000','811300000200000000') ) 
-- '811300000100000000' 
-- '811300000100000000'  Descontado do TTL da captacao! Descontar a Despesa da MARGEM.
-- 811851000100000000
SET @MARGEM_CAIXA_VEIC =@MARGEM_CAIXA_TTL / @CARTEIRA_TTL * @CARTEIRA_VEICULOS


/*
-- DESPESA ATRASO **********************************************************
BNDU
Provisão vendas de Bens	3	Diferença entre valor do carro e o valor de leilao	Despesa de Atraso


*/

/*
-- IMPOSTOS  **********************************************************
-- ir
SP_HELP DRE_SEM_VEIC
894101000100000000  89410100016	8.9.4.10.10.001-6	IRPJ
894201000100000000  89420100013	8.9.4.20.10.001-3	CSLL  Contribuição social - valores correntes
819251000100000000  81925100011	8.1.9.25.10.001-1	ISS
817692000200000000	8.1.7.69.20.002-9	ISS
--Crédito Tributário IR/CSLL
894103000100000000 8.9.4.10.30.001-2	Imposto de renda diferido -
894203000100000000 8.9.4.20.30.001-9 Contribuição social diferida -
SELECT	MOV_D_C ,*
	FROM	GER_BASE_BALANCETE (NOLOCK)  	WHERE	DT_FECHA='20150430'  AND EMPRESA=99	
	AND CONTA in ('894103000100000000','894203000100000000')

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.69.20.002-9')
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '8.1.7.99.10.004-1')

-- outras taxas
817991000400000000	8.1.7.99.10.004-1		Contr Sind Patronal
não utilizamos  tx jucesp
TRIBUTO_IRPJ_TTL
TRIBUTO_IRPJ_VEIC
TRIBUTO_CSSL_TTL
TRIBUTO_CSSL_VEIC
TRIBUTO_CRED_TRIB_TTL
TRIBUTO_CRED_TRIB_VEIC
TRIBUTO_OUTRAS_TXA_TTL
TRIBUTO_OUTRAS_TXA_VEIC
*/
SET @TRIBUTO_IRPJ_TTL =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('894101000100000000') )
SET @TRIBUTO_IRPJ_VEIC =@TRIBUTO_IRPJ_TTL / @CARTEIRA_TTL * @CARTEIRA_VEICULOS

SET @TRIBUTO_CSSL_TTL =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('894201000100000000') )
SET @TRIBUTO_CSSL_VEIC = @TRIBUTO_CSSL_TTL / @CARTEIRA_TTL * @CARTEIRA_VEICULOS



--Crédito Tributário IR/CSLL
SET @TRIBUTO_CRED_TRIB_TTL =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('894103000100000000','894203000100000000') )
SET @TRIBUTO_CRED_TRIB_VEIC =@TRIBUTO_CRED_TRIB_TTL / @CARTEIRA_TTL * @CARTEIRA_VEICULOS

--894103000100000000 8.9.4.10.30.001-2	Imposto de renda diferido -
--894203000100000000 8.9.4.20.30.001-9 Contribuição social diferida -



-- TRIBUTO_OUTRAS_TXA_TTL  TRIBUTO_OUTRAS_TXA_VEIC  Contribuição sindical patronal
SET @TRIBUTO_OUTRAS_TXA_TTL =	(SELECT	SUM(MOV_D_C)
	FROM	GER_BASE_BALANCETE (NOLOCK) 
	WHERE	DT_FECHA=@DTREF AND EMPRESA=99
		AND CONTA  IN ('817991000400000000') )

-- tributos OK JUL-14,  falta 100 K pis , cofins  AJUSTE 24-AGO-2015
if @DTREF = '20140731'
	set @TRIBUTO_OUTRAS_TXA_TTL =@TRIBUTO_OUTRAS_TXA_TTL + 100000.00

SET @TRIBUTO_OUTRAS_TXA_VEIC =@TRIBUTO_OUTRAS_TXA_TTL / @CARTEIRA_TTL * @CARTEIRA_VEICULOS



-- FIM IMPOSTOS  **********************************************************


-- ARMAZENAR CUSTOS E DESPESAS ******************************************

DELETE DRE_SEM_VEIC WHERE DT_FECHA = @DTREF

-- SP_HELP DRE_SEM_VEIC 
INSERT	DRE_SEM_VEIC 
SELECT	@DTREF,
		@CARTEIRA_VEICULOS,
		@CARTEIRA_OUTROS,
		@CARTEIRA_TTL,
		@CAPTACAO,
		@CAPTACAO_VEIC,
		@DESPESA_TTL		,  -- PESSOAL
		@DESPESA_VEIC		,

		@DESPESA_CAD_TTL		,
		@DESPESA_CAD_VEIC		,
		@DESPESA_COML_TTL		,
		@DESPESA_COML_VEIC		,
		@CUSTO_MANUT_TTL		,
		@CUSTO_MANUT_VEIC		,
		@MARGEM_CAIXA_TTL		,
		@MARGEM_CAIXA_VEIC		,
		@CUSTO_COBRANCA_TTL		,
		@CUSTO_COBRANCA_VEIC	,	
		@TRIBUTO_IRPJ_TTL		,
		@TRIBUTO_IRPJ_VEIC		,
		@TRIBUTO_CSSL_TTL		,
		@TRIBUTO_CSSL_VEIC		,
		@TRIBUTO_CRED_TRIB_TTL	,
		@TRIBUTO_CRED_TRIB_VEIC	,
		@TRIBUTO_OUTRAS_TXA_TTL	,
		@TRIBUTO_OUTRAS_TXA_VEIC,	

		@CM_TARIFAS_OUTRAS_RECEITA	,		-- CUSTO MANUTENCAO
		@CM_PROVISOES				,
		@CM_TARIFAS_DEPESA_OPER		,
		@CM_IMOBILIZADO				,
		@CM_DESP_PESSOAL			,
		@CM_DESP_DIRETORIA			,
		@CM_ALUGUEL					,
		@CM_ADM_FIXA				,
		@CM_ADM_VAR					,
		@CM_TARIFAS_OUTRAS_RECEITA_VEIC	,		-- CUSTO MANUTENCAO SOMENTE VEIC
		@CM_PROVISOES_VEIC				,
		@CM_TARIFAS_DEPESA_OPER_VEIC	,
		@CM_IMOBILIZADO_VEIC			,
		@CM_DESP_PESSOAL_VEIC			,
		@CM_DESP_DIRETORIA_VEIC			,
		@CM_ALUGUEL_VEIC				,
		@CM_ADM_FIXA_VEIC				,
		@CM_ADM_VAR_VEIC				,
		@CM_ADM_FIXA_CM				,  -- CUSTO DE MANUT E CUSTO DE COBRA
		@CM_ADM_FIXA_CC				,
		@CM_ADM_VAR_CM				,					
		@CM_ADM_VAR_CC				,
		@CM_ADM_FIXA_OUTRAS					
		, 0.0 ,0.0		-- qtde cart prod
		, 0.0 ,0.0, 0.0		-- custos

-- sp_help DRE_SEM_VEIC


-- ******************* COMISSAO  ***************************************************************
-- ******************* COMISSAO  ***************************************************************
-- ******************* COMISSAO  ***************************************************************

-- movi para ajustar a comissao JAN-17
UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.TC=	OPDESPESA3
	FROM	CDCSANTANAMicroCredito..COPER O (NOLOCK)
	WHERE	DT_FECHA = @DTREF		AND
			DRE_ATRASO.OPNROPER =O.OPNROPER
		AND DATEPART(MM,DT_BASE)  = DATEPART(MM,DT_FECHA)	 -- ********** ALTERADO P/ JAN17
		AND DATEPART(YYYY,DT_BASE)= DATEPART(YYYY,DT_FECHA)  -- ********** ALTERADO P/ JAN17



UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.VLR_COMISSAO=   -- 1,5 % LIBERADO + PARTE DA TC
						1.500/100.000 * LIBERADO + 
						CASE WHEN TC = 1350.0	THEN 490.0
							 WHEN TC = 1230.0	THEN 440.0
							ELSE 0.0 END	
	WHERE	DT_FECHA = @DTREF
		AND	DATEPART(YYYY,DT_BASE) IN ( 2015,2016)   -- ANO DO CONTRATO 2015  
	    AND RIGHT(OPNROPER,1) NOT IN ('A','B','C')  -- SEM RENEGOCIADOS
		AND DATEPART(MM,DT_BASE)  = DATEPART(MM,DT_FECHA)	 -- ********** ALTERADO EM JAN17
		AND DATEPART(YYYY,DT_BASE)= DATEPART(YYYY,DT_FECHA)  -- ********** ALTERADO EM JAN17

-- 6% do vlr financiado (lib+Tc+iof)
-- SELECT * FROM DRE_ATRASO
-- SP_HELP  DRE_ATRASO
UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.VLR_FINANCIADO= VLR_FINANCIADO + VLR_IOF + OPTAC  -- FINANCIADO LIQ + IOF + TC
	WHERE	DT_FECHA = @DTREF

UPDATE		DRE_ATRASO 
	SET 	REPASSE_AGENTE_6P =  VLR_FINANCIADO * 0.0600,
			VLR_COMISSAO_15   =  LIBERADO * 1.5000 / 100.00
	WHERE	DT_FECHA = @DTREF
		AND DATEPART(MM,DT_BASE)  = DATEPART(MM,DT_FECHA)	 -- ********** ALTERADO P/ JAN17
		AND DATEPART(YYYY,DT_BASE)= DATEPART(YYYY,DT_FECHA)  -- ********** ALTERADO P/ JAN17




-- 1/3 
/*


ALTER TABLE  DRE_ATRASO ADD VLR_COMISSAO FLOAT, VLR_COMISSAO_TERCO_AV FLOAT,VLR_COMISSAO_DIFERIDA_36AVOS FLOAT
ALTER TABLE  DRE_ATRASO ADD VLR_FINANCIADO FLOAT
ALTER TABLE  DRE_ATRASO ADD DT_BASE DATETIME

*/
-- VALOR DE COMISSAO CHEIO DE 2015  ****************************
UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.VLR_COMISSAO=   -- 1,5 % LIBERADO + PARTE DA TC
						1.500/100.000 * LIBERADO + 
						CASE WHEN TC = 1350.0	THEN 490.0
							 WHEN TC = 1230.0	THEN 440.0
							ELSE 0.0 END	
	WHERE	DT_FECHA = @DTREF
		AND	DATEPART(YYYY,DT_BASE) IN ( 2015, 2016)   -- ANO DO CONTRATO 
	    AND RIGHT(OPNROPER,1) NOT IN ('A','B','C')  -- SEM RENEGOCIADOS
		AND DATEPART(MM,DT_BASE)  = DATEPART(MM,DT_FECHA)	 -- ********** ALTERADO EM JAN17
		AND DATEPART(YYYY,DT_BASE)= DATEPART(YYYY,DT_FECHA)  -- ********** ALTERADO EM JAN17

		--		AND	PDECOR = 0								-- DT BASE NO MES DE FECHAMENTO


-- REPASSE DA TC ANTES DE 2014  ******************************


UPDATE		DRE_ATRASO 
SET			REPASSE_AGENTE_PROMOT 		=		CASE 
													 WHEN TC = 755.0	THEN 350.0 -- 2012
													 WHEN TC = 955.0 AND DATEPART(YYYY,DT_BASE) = 2012 AND DATEPART(MM,DT_BASE) = 3	    THEN 350.0 -- MAR 2012
													 WHEN TC = 955.0 AND DATEPART(YYYY,DT_BASE) = 2012 AND DATEPART(MM,DT_BASE) >= 4	THEN 450.0 -- >=ABR DE2012
													 WHEN TC = 955.0 AND DATEPART(YYYY,DT_BASE) = 2013	THEN 365.0 -- 2013
													 WHEN TC = 750.0	THEN 290.0 -- 2013
													 WHEN TC = 785.0	THEN 300.0 -- 2013
													 WHEN TC = 950.0	THEN 350.0 -- 2013 REPET
													 WHEN TC = 990.0	THEN 380.0 -- 2013
													 WHEN TC = 1200.0	THEN 450.0 -- 2013
													 WHEN TC = 1200.0	THEN 450.0 -- 2013
													 WHEN TC = 1250.0	THEN 490.0
													 WHEN TC = 1200.0	THEN 450.0
													 WHEN TC = 1000.0	THEN 390.0
													 WHEN TC = 1350.0	THEN 490.0
													 WHEN TC = 1100.0	THEN 390.0
													 WHEN TC = 950.0	THEN 350.0
													 WHEN TC = 1230.0	THEN 440.0
													ELSE 0.0 END	
	WHERE	DT_FECHA = @DTREF
		AND	DATEPART(YYYY,DT_BASE) < 2015   -- ANO DO CONTRATO ATEH 2014
	    AND RIGHT(OPNROPER,1) NOT IN ('A','B','C')  -- SEM RENEGOCIADOS
		AND DATEPART(MM,DT_BASE)  = DATEPART(MM,DT_FECHA)	 -- ********** ALTERADO EM JAN17
		AND DATEPART(YYYY,DT_BASE)= DATEPART(YYYY,DT_FECHA)  -- ********** ALTERADO EM JAN17
-- REPASSE DA TC DE 2015  ****************************
UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.REPASSE_AGENTE_PROMOT=  	CASE WHEN TC = 1350.0	THEN 490.0
													 WHEN TC = 1230.0	THEN 440.0
													ELSE 0.0 END	
	WHERE	DT_FECHA = @DTREF
		AND	DATEPART(YYYY,DT_BASE) IN ( 2015, 2016)   -- ANO DO CONTRATO  
	    AND RIGHT(OPNROPER,1) NOT IN ('A','B','C')  -- SEM RENEGOCIADOS
		AND DATEPART(MM,DT_BASE)  = DATEPART(MM,DT_FECHA)	 -- ********** ALTERADO EM JAN17
		AND DATEPART(YYYY,DT_BASE)= DATEPART(YYYY,DT_FECHA)  -- ********** ALTERADO EM JAN17
--  FIM    REPASSE DA TC ANTES DE 2014  ******************************


-- ********************
-- VALOR DE COMISSAO CHEIO ATE 2014  ****************************
UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.VLR_COMISSAO=   -- 1,5 % LIBERADO + PARTE DA TC
						1.500/100.000 * LIBERADO + 
						CASE 
							 WHEN TC = 755.0	THEN 350.0 -- 2012
							 WHEN TC = 955.0 AND DATEPART(YYYY,DT_BASE) = 2012 AND DATEPART(MM,DT_BASE) = 3	    THEN 350.0 -- MAR 2012
							 WHEN TC = 955.0 AND DATEPART(YYYY,DT_BASE) = 2012 AND DATEPART(MM,DT_BASE) >= 4	THEN 450.0 -- >=ABR DE2012
							 WHEN TC = 955.0 AND DATEPART(YYYY,DT_BASE) = 2013	THEN 365.0 -- 2013
							 WHEN TC = 750.0	THEN 290.0 -- 2013
							 WHEN TC = 785.0	THEN 300.0 -- 2013
							 WHEN TC = 950.0	THEN 350.0 -- 2013 REPET
							 WHEN TC = 990.0	THEN 380.0 -- 2013
							 WHEN TC = 1200.0	THEN 450.0 -- 2013
							 WHEN TC = 1200.0	THEN 450.0 -- 2013
							 WHEN TC = 1250.0	THEN 490.0
							 WHEN TC = 1200.0	THEN 450.0
							 WHEN TC = 1000.0	THEN 390.0
							 WHEN TC = 1350.0	THEN 490.0
							 WHEN TC = 1100.0	THEN 390.0
							 WHEN TC = 950.0	THEN 350.0
							 WHEN TC = 1230.0	THEN 440.0
							ELSE 0.0 END	
	WHERE	DT_FECHA = @DTREF
		AND	DATEPART(YYYY,DT_BASE) < 2015   -- ANO DO CONTRATO ATEH 2014
	    AND RIGHT(OPNROPER,1) NOT IN ('A','B','C')  -- SEM RENEGOCIADOS
		AND DATEPART(MM,DT_BASE)  = DATEPART(MM,DT_FECHA)	 -- ********** ALTERADO P/ JAN17
		AND DATEPART(YYYY,DT_BASE)= DATEPART(YYYY,DT_FECHA)  -- ********** ALTERADO P/ JAN17


-- ********************   2014  COMISSAO EM 36 MESES 1,5% + TC

UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.VLR_COMISSAO_DIFERIDA_36AVOS = VLR_COMISSAO  / 36.00   -- * 2.0/3.0
	WHERE	DT_FECHA = @DTREF
		AND	
			CONVERT(VARCHAR(4),DATEPART(YYYY,DT_BASE))+'-'+RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(MM,DT_BASE))),2)
		 <  CONVERT(VARCHAR(4),DATEPART(YYYY,DT_FECHA))+'-'+RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(MM,DT_FECHA))),2)
			-- ANO MES DO CONTRATO
	    AND   
				RIGHT(OPNROPER,1) NOT IN ('A','B','C')			-- SEM RENEGOCIADOS
			AND DATEPART(YYYY,DT_BASE) <=  2014  -- DIFERE EM 36 MESES




-- ********************   DIFERE 2015
-- VALOR DE COMISSAO CHEIO DE 2015  -- COMPARA O MAIOR
UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.COMISSAO_AV=    -- 6% DO FINANCIADO  (LIBERADO+TC+IOF)
	--		OU 1.5 LIB + PARTE TC		
	CASE WHEN	VLR_COMISSAO_15 < REPASSE_AGENTE_6P THEN VLR_COMISSAO_15+REPASSE_AGENTE_PROMOT
		 ELSE   REPASSE_AGENTE_6P END
	WHERE	DT_FECHA = @DTREF
		AND	DATEPART(YYYY,DT_BASE) IN ( 2015, 2016 )			-- ANO DO CONTRATO 
	    AND RIGHT(OPNROPER,1) NOT IN ('A','B','C')  -- SEM RENEGOCIADOS
		AND DATEPART(MM,DT_BASE)  = DATEPART(MM,DT_FECHA)	 -- ********** ALTERADO EM JAN17
		AND DATEPART(YYYY,DT_BASE)= DATEPART(YYYY,DT_FECHA)  -- ********** ALTERADO EM JAN17

-- 2015
-- DIFERE 1/3 NO MES DO CONTRATO  (ANO MES =)
UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.VLR_COMISSAO_TERCO_AV = COMISSAO_AV / 3.00
	WHERE	DT_FECHA = @DTREF
		AND	
/*			DATEPART(YYYY,DT_BASE) = DATEPART(YYYY,DT_FECHA)-- ANO DO CONTRATO
		AND DATEPART(MM,DT_BASE) = DATEPART(MM,DT_FECHA)	-- MES DO CONTRATO
	    AND	*/
			 RIGHT(OPNROPER,1) NOT IN ('A','B','C')			-- SEM RENEGOCIADOS
		AND DATEPART(YYYY,DT_BASE) IN ( 2015, 2016)  -- DIFERE 1/3 AV    
		AND DATEPART(MM,DT_BASE)  = DATEPART(MM,DT_FECHA)	 -- ********** ALTERADO EM JAN17
		AND DATEPART(YYYY,DT_BASE)= DATEPART(YYYY,DT_FECHA)  -- ********** ALTERADO EM JAN17

UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.COMISSAO_2_3 = VLR_COMISSAO_TERCO_AV * 2.0000000000/ 3.000000000000,
			DRE_ATRASO.DESPESA_CONTRATO = VLR_COMISSAO_TERCO_AV * 2.0000000000/ 3.000000000000 / 36.000000000000
	WHERE	DT_FECHA = @DTREF
		AND
/*			DATEPART(YYYY,DT_BASE) = DATEPART(YYYY,DT_FECHA)-- ANO DO CONTRATO
		AND DATEPART(MM,DT_BASE) = DATEPART(MM,DT_FECHA)	-- MES DO CONTRATO
	    AND		*/
			RIGHT(OPNROPER,1) NOT IN ('A','B','C')			-- SEM RENEGOCIADOS
		AND DATEPART(YYYY,DT_BASE) IN ( 2015, 2016)  -- DIFERE 1/3 AV  
		AND DATEPART(MM,DT_BASE)  = DATEPART(MM,DT_FECHA)	 -- ********** ALTERADO EM JAN17
		AND DATEPART(YYYY,DT_BASE)= DATEPART(YYYY,DT_FECHA)  -- ********** ALTERADO EM JAN17
-- COMISSAO_2_3  ANTES VLR_COMISSAO_DIFERIDA_36AVOS

-- VALOR DE COMISSAO CHEIO DE 2015  -- COMPARA O MAIOR
UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.VLR_COMISSAO=   -- 6% DO FINANCIADO regra BACEN
			-- 1,5% LIBER  + REPASSE TC = COMISSAO 2015
			CASE WHEN VLR_COMISSAO  < REPASSE_AGENTE_6P THEN VLR_COMISSAO 
				 ELSE REPASSE_AGENTE_6P END 
						-- 1,5 % LIBERADO + PARTE DA TC
	WHERE	DT_FECHA = @DTREF
		AND	DATEPART(YYYY,DT_BASE) IN (2015, 2016)			-- ANO DO CONTRATO
	    AND RIGHT(OPNROPER,1) NOT IN ('A','B','C')  -- SEM RENEGOCIADOS
		AND DATEPART(MM,DT_BASE)  = DATEPART(MM,DT_FECHA)	 -- ********** ALTERADO EM JAN17
		AND DATEPART(YYYY,DT_BASE)= DATEPART(YYYY,DT_FECHA)  -- ********** ALTERADO EM JAN17

--VLR_COMISSAO_TERCO_AV	VLR_COMISSAO_DIFERIDA_36AVOS

-- DIFERE 2/3 EM 36 MESES
UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.SLD_DIFERIR_2_3 = COMISSAO_AV - COMISSAO_AV / 3.0000000000 
	WHERE	DT_FECHA = @DTREF
		AND	
/*
CONVERT(VARCHAR(4),DATEPART(YYYY,DT_BASE))+'-'+RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(MM,DT_BASE))),2)
		 <  CONVERT(VARCHAR(4),DATEPART(YYYY,DT_FECHA))+'-'+RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(MM,DT_FECHA))),2)
			-- ANO MES DO CONTRATO
	    AND   */
			RIGHT(OPNROPER,1) NOT IN ('A','B','C')			-- SEM RENEGOCIADOS
		AND DATEPART(YYYY,DT_BASE) IN ( 2015, 2016)  -- DIFERE 1/3 AV   

-- DIFERE  36 MESES
UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.VLR_COMISSAO_DIFERIDA_36AVOS = SLD_DIFERIR_2_3  / 36.00 
	WHERE	DT_FECHA = @DTREF	AND
	/*
CONVERT(VARCHAR(4),DATEPART(YYYY,DT_BASE))+'-'+RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(MM,DT_BASE))),2)
		 <  CONVERT(VARCHAR(4),DATEPART(YYYY,DT_FECHA))+'-'+RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(MM,DT_FECHA))),2)
			-- ANO MES DO CONTRATO
	    AND		*/
			RIGHT(OPNROPER,1) NOT IN ('A','B','C')			-- SEM RENEGOCIADOS
		AND DATEPART(YYYY,DT_BASE) IN ( 2015, 2016)  -- DIFERE 1/3 AV   


/*
SLD_DIFERIR_2_3

UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.VLR_COMISSAO_DIFERIDA_36AVOS = VLR_COMISSAO_AV * 2.00 / 3.00 / 36.00  
	WHERE	CONVERT(VARCHAR(4),DATEPART(YYYY,DT_BASE))+'-'+RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(MM,DT_BASE))),2)
		 <  CONVERT(VARCHAR(4),DATEPART(YYYY,DT_FECHA))+'-'+RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(MM,DT_FECHA))),2)
			-- ANO MES DO CONTRATO
	    AND RIGHT(OPNROPER,1) NOT IN ('A','B','C')			-- SEM RENEGOCIADOS
		AND DATEPART(YYYY,DT_BASE) =  2015  -- DIFERE 1/3 AV
*/
--RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(MONTH,@DATA_REF))),2) 
--VLR_COMISSAO_DIFERIDA_36AVOS

-- *****************************************************************************
-- CONTRATOS SOMENTE COM DIFERIMENTO DE COMISSAO
-- SEM CARTEIRA
/*
SELECT DATEADD (MM, -36,'20150430')
2012-04-30 00:00:00.000
@DTREF
-- PGTOS ANTECIPADOS OU LIQ ANTES DO PERIODO
-- OPERACOES DE VEIC APOS 36 MESES
 SELECT * 
	FROM	CDCSANTANAMicroCredito..COPER O (NOLOCK)
	WHERE	-- PRODUCAO
			--CONVERT(VARCHAR(8),OPDTBASE,112) BETWEEN @DTINI AND @DTFIM 
OPDTBASE BETWEEN '20140430' AND '20141231'
		--   LISTA COM MODALIDADES DO PRODUTO VEIC
		AND OPCODOP IN (SELECT	M.COD_MODA--, *
						FROM	 Ttipo_prod T (NOLOCK), TModa_tipo_prod M (NOLOCK)  
						WHERE	M.COD_PROD = T.COD_PROD 
							AND T.COD_MODALIDADE = M.COD_MODALIDADE 
						AND T.COD_PROD = 'V' )
-- SEM CARTEIRA
AND OPNROPER NOT IN (SELECT DRE.OPNROPER FROM DRE_ATRASO DRE (NOLOCK) )
-- SEM RENEG
AND OPNROPER+'A' NOT IN (SELECT DRE.OPNROPER FROM DRE_ATRASO DRE (NOLOCK) )
AND OPNROPER+'B' NOT IN (SELECT DRE.OPNROPER FROM DRE_ATRASO DRE (NOLOCK) )

-- 126 COM RENEG, SEM RENEG 85, SEM RENEG B 84

-- RENEG??
 SELECT * 	FROM	CDCSANTANAMicroCredito..COPER O (NOLOCK)
WHERE OPNROPER='612162225A'

SP_HELP DRE_ATRASO 
*/

-- SEM DIFERIMENTO DE COMISSAO 36 MESES
/*
DECLARE @DT36M DATETIME
SET		@DT36M =DATEADD (MM, -36,@DTREF)
SET		@DT36M =DATEADD (DD, +1 ,@DT36M)  -- CONTRATOS 36M 

DECLARE @DT2014 DATETIME
SET		@DT2014 ='20141231'  -- FIM 2014



-- OPERACOES DE VEIC APOS 36 MESES LIQUIDADAS MAS COM DIFERIMENTO 36 MESES
INSERT	DRE_ATRASO 
/*
SP_HELP DRE_ATRASO 
(DT_FECHA, OPNROPER, CONTRATOoriginal, DESCR_TIPO, NVL_RISCO, 
		LOAN, LIBERADO, OCUPACAO,
		IDADE,
		ClSexo,
		ClESTciv,
		TIPO_CASA,
		LojaCod,
		LojaCEP,
		LojaCIDADE,
		LojaUF,
		AGENTEcod,
		OperadorCod,
		TC,
		OPTAC,
		PASLDXMLT,
		PASLDXMR,
		PDD,
		VLR_PDD_ATU,
		VLR_PDD_ANT,
		NVL_RISCO_ANT,
		VLR_PARCELA,
		VLR_RETORNO,
		VLR_RECEITA,
		VLR_IOF,
		VLR_ISS,
		VLR_PIS,
		VLR_COFINS,
		VLR_CAPTACAO,
		vlr_IRPJ,
		VLR_CSSL,
		VLR_CRED_TRIB,
		OUTRAS_TX,
		REC_APLIC_SLDO_CX,
		REPASSE_AGENTE_6P,
		RETORNO_LOJA,
		REPASSE_AGENTE_PROMOT,
		DESP_CAPT_SLD_CX,
		DESP_CAPT_OPER,
		DESP_PESSOAL_VDA,
		DESP_PESSOAL_SUP,
		SLDO_INSCRITO,
		PROPORCAO_CARTEIRA,
		VLR_COMISSAO,
		VLR_COMISSAO_TERCO_AV,
		VLR_COMISSAO_DIFERIDA_36AVOS,
		VLR_FINANCIADO,
		DT_BASE)
alter table DRE_ATRASO  add vlr_comissao_diferida_pzo_Op float

*/
 SELECT		@DTREF , OPNROPER, OPNROPER, 
			(SELECT	DESCR_TIPO
						FROM	 Ttipo_prod T (NOLOCK), TModa_tipo_prod M (NOLOCK)  
						WHERE	M.COD_PROD = T.COD_PROD 
							AND T.COD_MODALIDADE = M.COD_MODALIDADE 
						AND T.COD_PROD = 'V'  AND COD_MODA = OPCODOP ),
			--DESCR_TIPO, 
			'',		-- NVL RISCO
			0.0,0.0, 0.0,		-- LOAN, LIB, TAB
			-- PLANO, PDECOR
			OPQTDDPARC, CASE WHEN DATEDIFF(MM, OPDTBASE, @DTREF) < OPQTDDPARC THEN DATEDIFF(MM, OPDTBASE, @DTREF)
							 ELSE OPQTDDPARC END, -- PARCELAS DECORRIDAS
			0,  --PARC
			-- CLCEPFIS, CLCIDFIS, CLUFFIS,CLRENDA, OCUPACAO, IDADE, ClSexo, ClESTciv, TIPO_CASA
			'','','', 0.0,'',0, '',0, '', -- CLI
				

/*  CLIENTE
SP_HELP DRE_ATRASO
			CLCEPFIS , CLCIDFIS, CLUFFIS, 
			ISNULL(CLRENDA,0.0), 
			'' AS OCUPACAO,
			DATEDIFF(YY,CLDTNASC,@DTREF) AS IDADE,
			ClSexo,ClESTciv, 
			-- TIPO CASA ??
			'' AS TIPO_CASA,  */

			OpCodORG4	AS LojaCod, 
			O4CEP		AS LojaCEP,
			O4CID		AS LojaCIDADE,
			O4UF		AS LojaUF,
			O3CODORGA13 AS AGENTEcod,
			OpCodORG3   AS OperadorCod,

		--	'','','','','',  -- COML
			0.0,0.0, 0.0, 0.0,  -- TC
			0.0, 0.0,0.0,'',   -- PDD
			0.0, 0.0,0.0,		-- VLR PARC
			0.0,0.0, 0.0,0.0,   -- IOF IMPOSTOS
			0.0,0.0, 0.0,0.0, 0.0,  -- CAPTACAO  ***********  vlr_IRPJ ,VLR_CSSL, VLR_CRED_TRIB, OUTRAS_TX
			0.0,0.0, 0.0,0.0,		-- REC_APLIC_SLD ,REPASSE_AGENTE_6P , RETORNO_LOJA , REPASSE_AGENTE_PROMOT
			0.0,0.0, 0.0,0.0,  -- DESP  DESP_CAPT_SLD_CX , DESP_CAPT_OPER , DESP_PESSOAL_VDA, DESP_PESSOAL_SUP
			0.0,0.0,  -- SLDO_INSCRITO , PROPORCAO_CARTEIRA

			-- VLR_COMISSAO
			-- 1,5 % LIBERADO + PARTE DA TC
						1.500/100.000 * OPVLRFIN + 
						CASE
							 WHEN OpDESPESA3 = 755.0	THEN 350.0 -- 2012
							 WHEN OpDESPESA3 = 955.0 AND DATEPART(YYYY,OPDTBASE) = 2012 AND DATEPART(MM,OPDTBASE) = 3	THEN 350.0 -- MAR 2012
							 WHEN OpDESPESA3 = 955.0 AND DATEPART(YYYY,OPDTBASE) = 2012 AND DATEPART(MM,OPDTBASE) >= 4	THEN 450.0 -- >=ABR DE2012
							 WHEN OpDESPESA3 = 955.0 AND DATEPART(YYYY,OPDTBASE) = 2013	THEN 365.0 -- 2013
							 WHEN OpDESPESA3 = 750.0	THEN 290.0 -- 2013
							 WHEN OpDESPESA3 = 785.0	THEN 300.0 -- 2013
							 WHEN OpDESPESA3 = 950.0	THEN 350.0 -- 2013 REPET
							 WHEN OpDESPESA3 = 990.0	THEN 380.0 -- 2013
							 WHEN OpDESPESA3 = 1200.0	THEN 450.0 -- 2013
							 WHEN OpDESPESA3 = 1200.0	THEN 450.0 -- 2013
							 WHEN OpDESPESA3 = 1250.0	THEN 490.0
							 WHEN OpDESPESA3 = 1200.0	THEN 450.0
							 WHEN OpDESPESA3 = 1000.0	THEN 390.0
							 WHEN OpDESPESA3 = 1350.0	THEN 490.0
							 WHEN OpDESPESA3 = 1100.0	THEN 390.0
							 WHEN OpDESPESA3 = 950.0	THEN 350.0
							 WHEN OpDESPESA3 = 1230.0	THEN 440.0
							ELSE 0.0 END	

			-- VLR_COMISSAO_TERCO_AV
			,0.0,    
			-- 1,5 % LIBERADO + PARTE DA TC				VLR_COMISSAO_DIFERIDA_36AVOS
						(1.500/100.000 * OPVLRFIN + 
						CASE 
							 WHEN OpDESPESA3 = 755.0	THEN 350.0 -- 2012
							 WHEN OpDESPESA3 = 955.0 AND DATEPART(YYYY,OPDTBASE) = 2012 AND DATEPART(MM,OPDTBASE) = 3	THEN 350.0 -- MAR 2012
							 WHEN OpDESPESA3 = 955.0 AND DATEPART(YYYY,OPDTBASE) = 2012 AND DATEPART(MM,OPDTBASE) >= 4	THEN 450.0 -- >=ABR DE2012
							 WHEN OpDESPESA3 = 955.0 AND DATEPART(YYYY,OPDTBASE) = 2013	THEN 365.0 -- 2013
							 WHEN OpDESPESA3 = 750.0	THEN 290.0 -- 2013
							 WHEN OpDESPESA3 = 785.0	THEN 300.0 -- 2013
							 WHEN OpDESPESA3 = 950.0	THEN 350.0 -- 2013 REPET
							 WHEN OpDESPESA3 = 990.0	THEN 380.0 -- 2013
							 WHEN OpDESPESA3 = 1200.0	THEN 450.0 -- 2013
							 WHEN OpDESPESA3 = 1200.0	THEN 450.0 -- 2013
							 WHEN OpDESPESA3 = 1250.0	THEN 490.0
							 WHEN OpDESPESA3 = 1200.0	THEN 450.0
							 WHEN OpDESPESA3 = 1000.0	THEN 390.0
							 WHEN OpDESPESA3 = 1350.0	THEN 490.0
							 WHEN OpDESPESA3 = 1100.0	THEN 390.0
							 WHEN OpDESPESA3 = 950.0	THEN 350.0
							 WHEN OpDESPESA3 = 1230.0	THEN 440.0
							ELSE 0.0 END)/36.0	,  -- COMISS 1/36
			OPVLRFIN,OPDTBASE			-- VLR_FINANCIADO , DT_BASE
			,0.0			-- vlr comissao diferido no prazo do contrato				vlr_comissao_diferida_pzo_Op
			,0.0,0.0		-- COMISSAO_AV  ,	SLD_DIFERIR_2_3
			,0.0,0.0		-- COMISSAO_2_3,	VLR_COMISSAO_15
			,0.0		-- FIM COMISS			DESPESA_CONTRATO
			,0.0, 0.0    -- DESPESA_CADASTRO,	DESPESA_COMERCIAL
			,0.0 ,0.0,0.0, 0.0, 0.0			,0.0 ,0.0,0.0, 0.0, 0.0  ,0.0 ,0.0  -- CM
			,0.0 ,0.0,0.0, 0.0, 0.0			,0.0
	FROM	CDCSANTANAMicroCredito..COPER O (NOLOCK)
		LEFT JOIN	(SELECT  * 
						FROM	CDCSANTANAMicroCredito..TORG3 OP (NOLOCK) 
							) AS OPERADOR
				ON	O3CODORG = OpCodORG3  -- OPERADOR

		LEFT JOIN	(SELECT  * 
						FROM	CDCSANTANAMicroCredito..TORG4 OP (NOLOCK) 
							) AS LOJA
				ON	O4CODORG = OpCodORG4  -- OPERADOR
	WHERE	-- PRODUCAO
			--CONVERT(VARCHAR(8),OPDTBASE,112) BETWEEN @DTINI AND @DTFIM 
			OPDTBASE BETWEEN @DT36M AND @DT2014
		--   LISTA COM MODALIDADES DO PRODUTO VEIC
		AND OPCODOP IN (SELECT	M.COD_MODA
						FROM	 Ttipo_prod T (NOLOCK), TModa_tipo_prod M (NOLOCK)  
						WHERE	M.COD_PROD = T.COD_PROD 
							AND T.COD_MODALIDADE = M.COD_MODALIDADE 
						AND T.COD_PROD = 'V' )
		-- SEM CARTEIRA
		AND OPNROPER NOT IN (SELECT DRE.OPNROPER FROM DRE_ATRASO DRE (NOLOCK) 	WHERE	DT_FECHA = @DTREF )
		-- SEM RENEG
		AND OPNROPER+'A' NOT IN (SELECT DRE.OPNROPER FROM DRE_ATRASO DRE (NOLOCK) )
		AND OPNROPER+'B' NOT IN (SELECT DRE.OPNROPER FROM DRE_ATRASO DRE (NOLOCK) )


-- ********************   COMISSAO DIFERIDA NO PRAZO DO CONTRATO ************* NOVA COLUNA
-- SP_HELP DRE_ATRASO 
-- DECLARE @DTREF DATETIME SET @DTREF ='20150430'
-- SELECT '2013-01-30'
-- SELECT dateadd(mm,36, '2013-01-30')
-- SELECT CONVERT(VARCHAR(4),DATEPART(YYYY,dateadd(mm,36, '2013-01-30')))+'-'+ RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(mm,dateadd(mm,36, '2013-01-30')))),2)

UPDATE		DRE_ATRASO 
	SET 	DRE_ATRASO.vlr_comissao_diferida_pzo_Op = VLR_COMISSAO / CONVERT(FLOAT,OPQTDDPARC)
	WHERE	DT_FECHA = @DTREF
	AND		RIGHT(OPNROPER,1) NOT IN ('A','B','C')			-- SEM RENEGOCIADOS
			-- fim do contrato >= a Data REF
			-- 11 PARCELAS DE JAN-14 = DEZ-14      DTREF ATEH
	AND		CONVERT(VARCHAR(4),DATEPART(YYYY,dateadd(mm,OPQTDDPARC, DT_BASE)))+'-'+ RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(mm,dateadd(mm,OPQTDDPARC, DT_BASE)))),2)>= 
			CONVERT(VARCHAR(4),DATEPART(YYYY,@DTREF))+'-'+ RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(mm,@DTREF))),2)
*/
-- SEM DIFERIMENTO DE COMISSAO 36 MESES


-- ZERA DESPESAS Q NAO SAO DO MES
UPDATE	DRE_ATRASO
SET		TC=0.0, VLR_IOF =0.0, VLR_COMISSAO_TERCO_AV=0.0
WHERE	DT_FECHA = @DTREF
	AND	NOT (PDECOR =0  -- CONTRATO NAO EH DO MES REF
	AND	DESCR_TIPO  <> ('Renegociacao') )  -- SEM RENEGOCIADOS

/*
SELECT SUM(O.OPDESPESA4/O.OPQTDDPARC) -- RETORNO
FROM CDCSANTANAMicroCredito..COPER O (NOLOCK) JOIN
	 (SELECT * FROM DRE_ATRASO  (NOLOCK) WHERE DT_FECHA='20150430') AS D
ON O.OPNROPER = D.OPNROPER
*/
-- DECLARE @DTREF DATETIME SET @DTREF = '20150430' 
UPDATE	DRE_ATRASO
SET		VLR_RETORNO = CASE WHEN ISNULL(O.OPQTDDPARC,0)=0 THEN O.OPDESPESA4/CONVERT(FLOAT,O.OPQTDDPARC) ELSE 0.0 END
FROM	CDCSANTANAMicroCredito..COPER O (NOLOCK) 
WHERE	DT_FECHA = @DTREF
	AND DRE_ATRASO.OPNROPER = O.OPNROPER	



-- VALOR DE COMISSAO 2017  **************************** ALTERACAO DE REGRA DE TC JAN-17 ****************
IF 	DATEPART(YYYY,@DTREF) =   2017
BEGIN

	UPDATE		DRE_ATRASO		 -- 1,5 % LIBERADO + PARTE DA TC
		SET 	DRE_ATRASO.VLR_COMISSAO=  	0.0  ,
				VLR_RETORNO=0.0, REPASSE_AGENTE_PROMOT = 0.0
		WHERE	DT_FECHA = @DTREF	
	-- TABELA AUXILIAR PARA IDENTIFICAR O AGENTE
	-- DROP   TABLE AUX_DRE_PROMOTORA 
	-- CREATE TABLE AUX_DRE_PROMOTORA (OPNROPER	VARCHAR(20),OPERADOR VARCHAR(20), PROMOTORA VARCHAR(20)) 
	-- CREATE INDEX AUX_DRE_PROMOTORA_IDX1 ON AUX_DRE_PROMOTORA (OPNROPER) 
	-- CREATE INDEX AUX_DRE_PROMOTORA_IDX2 ON AUX_DRE_PROMOTORA (OPERADOR) 
	TRUNCATE	TABLE	AUX_DRE_PROMOTORA
	INSERT		AUX_DRE_PROMOTORA
		SELECT	DISTINCT OPNROPER, '', ''	
		FROM	DRE_ATRASO (NOLOCK) WHERE DT_FECHA = @DTREF
			AND DATEPART(MM,DT_BASE)  = DATEPART(MM,DT_FECHA)	 -- ********** OPERACOES DO MES
			AND DATEPART(YYYY,DT_BASE)= DATEPART(YYYY,DT_FECHA)  -- ********** ALTERADO P/ JAN17
	UPDATE		AUX_DRE_PROMOTORA
		SET		OPERADOR = OPCODORG3			-- OPERADOR
		FROM	CDCSANTANAMicroCredito..COPER O (NOLOCK)	
		WHERE	AUX_DRE_PROMOTORA.opNroper = O.opNroper
	UPDATE		AUX_DRE_PROMOTORA
		SET		PROMOTORA = O3CODORGA13			-- AGENTE
		FROM	CDCSANTANAMicroCredito..TORG3 O (NOLOCK)	
		WHERE	AUX_DRE_PROMOTORA.OPERADOR = O.O3CODORG
	UPDATE		DRE_ATRASO		 -- 1,5 % LIBERADO + PARTE DA TC
		SET 	DRE_ATRASO.VLR_COMISSAO=  	1.500/100.000 * LIBERADO  ,
--					ISNULL(VLR_RETORNO,0.0) + ISNULL(VLR_COMISSAO,0.0) +ISNULL(REPASSE_AGENTE_PROMOT,0.0) 
				DRE_ATRASO.VLR_RETORNO=0.0, REPASSE_AGENTE_PROMOT = 0.0
--		FROM	AUX_DRE_PROMOTORA (NOLOCK)	
		WHERE	DT_FECHA = @DTREF
--			AND OPNROPER = AUX_DRE_PROMOTORA.OPNROPER
			AND	DATEPART(YYYY,DT_BASE) IN (  2017)   -- ANO DO CONTRATO ********* alterado p/ JAN17
			AND RIGHT(OPNROPER,1) NOT IN ('A','B','C')  -- SEM RENEGOCIADOS
			AND DATEPART(MM,DT_BASE)  = DATEPART(MM,DT_FECHA)	 -- ********** ALTERADO P/ JAN17
			AND DATEPART(YYYY,DT_BASE)= DATEPART(YYYY,DT_FECHA)  -- ********** ALTERADO P/ JAN17

	UPDATE		DRE_ATRASO		 -- 1,5 % LIBERADO + PARTE DA TC
		SET 	--DRE_ATRASO.VLR_COMISSAO=  	1.500/100.000 * LIBERADO  ,
--					ISNULL(VLR_RETORNO,0.0) + ISNULL(VLR_COMISSAO,0.0) +ISNULL(REPASSE_AGENTE_PROMOT,0.0) 
				--DRE_ATRASO.VLR_RETORNO=0.0, 
				-- REGRA DE TC  109 = PROMOTORA APROV SP
				REPASSE_AGENTE_PROMOT = CASE WHEN P.PROMOTORA = '109' AND  DESCR_TIPO ='MOTOS'  THEN 540.0
											 WHEN P.PROMOTORA = '109' AND  DESCR_TIPO <>'MOTOS' THEN 590.0
											 WHEN P.PROMOTORA = '120' AND  DESCR_TIPO ='MOTOS'  THEN 440.0
											 WHEN P.PROMOTORA = '120' AND  DESCR_TIPO <>'MOTOS'  THEN 490.0
											 WHEN P.PROMOTORA NOT IN ('109', '120') AND  DESCR_TIPO = 'MOTOS'  THEN 500.0
											 WHEN P.PROMOTORA NOT IN ('109', '120') AND  DESCR_TIPO <>'MOTOS'  THEN 550.0
											 ELSE 0.0	END
		FROM	AUX_DRE_PROMOTORA P (NOLOCK)	
		WHERE	DT_FECHA = @DTREF
			AND DRE_ATRASO.OPNROPER = P.OPNROPER
			AND	DATEPART(YYYY,DT_BASE) IN (  2017)   -- ANO DO CONTRATO ********* alterado p/ JAN17
			AND RIGHT(DRE_ATRASO.OPNROPER,1) NOT IN ('A','B','C')  -- SEM RENEGOCIADOS
			AND DATEPART(MM,DT_BASE)  = DATEPART(MM,DT_FECHA)	 -- ********** ALTERADO P/ JAN17
			AND DATEPART(YYYY,DT_BASE)= DATEPART(YYYY,DT_FECHA)  -- ********** ALTERADO P/ JAN17

END		


-- FIM   ******************* COMISSAO  ***************************************************************
-- FIM   ******************* COMISSAO  ***************************************************************


--	 DRE_SEM_VEIC QTDE CARTEIRA E QTDE PRODUCAO
/*
ALTER TABLE DRE_SEM_VEIC ADD  QTD_CARTEIRA			FLOAT
ALTER TABLE DRE_SEM_VEIC ADD  QTD_PRODUCAO			FLOAT
*/

DECLARE @QTD_PRODUCAO FLOAT
DECLARE @QTD_CARTEIRA FLOAT

-- QTDE PRODUCAO
UPDATE	DRE_SEM_VEIC
SET		QTD_PRODUCAO = QTDE,
		@QTD_PRODUCAO = QTDE
FROM	(SELECT		COUNT(D.OPNROPER) AS QTDE FROM 	DRE_ATRASO D (NOLOCK) 
			WHERE 	D.DT_FECHA = @DTREF 
			AND  (	PDECOR =0  -- CONTRATO PRODUZIDO DO MES REF  com reneg
				--AND	DESCR_TIPO  <> ('Renegociacao') 
					)  ) AS TTL
WHERE	DT_FECHA = @DTREF
-- QTDE CARTEIRA
UPDATE	DRE_SEM_VEIC
SET		QTD_CARTEIRA = QTDE,
		@QTD_CARTEIRA = QTDE
FROM	(SELECT		COUNT(D.OPNROPER) AS QTDE FROM 	DRE_ATRASO D (NOLOCK) 
			WHERE 	D.DT_FECHA = @DTREF 
				AND	NVL_RISCO NOT IN ( 'HH') -- '' somente sem prejuizo
			) AS TTL
WHERE	DT_FECHA = @DTREF

-- DESPESAS *************************** RATEIO
/*
ALTER TABLE  DRE_ATRASO ADD DESPESA_CADASTRO FLOAT
ALTER TABLE  DRE_ATRASO ADD DESPESA_COMERCIAL FLOAT

ALTER TABLE  DRE_ATRASO ADD CM_TARIFA FLOAT
ALTER TABLE  DRE_ATRASO ADD CM_PROVISAO FLOAT
ALTER TABLE  DRE_ATRASO ADD CM_TARIFA_DESPESA FLOAT
ALTER TABLE  DRE_ATRASO ADD CM_IMOBILIZADO FLOAT
ALTER TABLE  DRE_ATRASO ADD CM_DESP_PESSOAL FLOAT

ALTER TABLE  DRE_ATRASO ADD CM_DIRETORIA FLOAT
ALTER TABLE  DRE_ATRASO ADD CM_ALUGUEL FLOAT
ALTER TABLE  DRE_ATRASO ADD CM_ADM_FIXA FLOAT
ALTER TABLE  DRE_ATRASO ADD CM_ADM_VAR	FLOAT
ALTER TABLE  DRE_ATRASO ADD CM_ADM_OUTRAS_TTL2 FLOAT
ALTER TABLE  DRE_ATRASO ADD CM_ADM_OUTRAS_TTL3 FLOAT
ALTER TABLE  DRE_ATRASO ADD CM_ADM_VAR_COM	FLOAT

--ALTER TABLE  DRE_ATRASO ADD CM_ADM_TTL2 FLOAT ALTER TABLE  DRE_ATRASO ADD CM_ADM_TTL3 FLOAT
ALTER TABLE  DRE_ATRASO ADD CUSTO_COBRANCA FLOAT
ALTER TABLE  DRE_ATRASO ADD MARGEM_CAIXA FLOAT
ALTER TABLE  DRE_ATRASO ADD DESPESA_ATRASO FLOAT

ALTER TABLE  DRE_ATRASO ADD DESPESA_ATRASO FLOAT

ALTER TABLE  DRE_ATRASO ADD VLR_LUCRO_BRUTO FLOAT
ALTER TABLE  DRE_ATRASO ADD CUSTO_MANUTENCAO FLOAT
vlr_IRPJ
VLR_CSSL
VLR_ISS
VLR_CRED_TRIB
OUTRAS_TX

-- DESPESAS 
DESPESA_SUP_TTL		FLOAT,
DESPESA_SUP_VEIC	FLOAT,
DESPESA_CAD_TTL		FLOAT,
DESPESA_CAD_VEIC	FLOAT,
DESPESA_COML_TTL	FLOAT,
DESPESA_COML_VEIC	FLOAT,
CUSTO_MANUT_TTL		FLOAT,
CUSTO_MANUT_VEIC	FLOAT,
MARGEM_CAIXA_TTL	FLOAT,
MARGEM_CAIXA_VEIC	FLOAT,
CUSTO_COBRANCA_TTL	FLOAT,
CUSTO_COBRANCA_VEIC	FLOAT,
TRIBUTO_IRPJ_TTL	FLOAT,
TRIBUTO_IRPJ_VEIC	FLOAT,
TRIBUTO_CSSL_TTL	FLOAT,
TRIBUTO_CSSL_VEIC	FLOAT,
TRIBUTO_CRED_TRIB_TTL	FLOAT,
TRIBUTO_CRED_TRIB_VEIC	FLOAT,
TRIBUTO_OUTRAS_TXA_TTL	FLOAT,
TRIBUTO_OUTRAS_TXA_VEIC	FLOAT,
CM_TARIFAS_OUTRAS_RECEITA	FLOAT,		-- CUSTO MANUTENCAO
CM_PROVISOES				FLOAT,
CM_TARIFAS_DEPESA_OPER		FLOAT,
CM_IMOBILIZADO				FLOAT,
CM_DESP_PESSOAL				FLOAT,
CM_DESP_DIRETORIA			FLOAT,
CM_ALUGUEL					FLOAT,
CM_ADM_FIXA					FLOAT,
CM_ADM_VAR					FLOAT,
CM_TARIFAS_OUTRAS_RECEITA_VEIC	FLOAT,		-- CUSTO MANUTENCAO SOMENTE VEIC
CM_PROVISOES_VEIC				FLOAT,
CM_TARIFAS_DEPESA_OPER_VEIC	FLOAT,
CM_IMOBILIZADO_VEIC			FLOAT,
CM_DESP_PESSOAL_VEIC		FLOAT,
CM_DESP_DIRETORIA_VEIC		FLOAT,
CM_ALUGUEL_VEIC				FLOAT,
CM_ADM_FIXA_VEIC			FLOAT,
CM_ADM_VAR_VEIC				FLOAT,
CM_ADM_FIXA_CM				FLOAT,
CM_ADM_FIXA_CC				FLOAT,
CM_ADM_VAR_CM				FLOAT,					
CM_ADM_VAR_CC				FLOAT,
CM_ADM_FIXA_OUTRAS			FLOAT

 )

SP_HELP DRE_SEM_VEIC
ALTER TABLE DRE_SEM_VEIC ADD  CM_ADM_FIXA_OUTRAS			FLOAT

ALTER TABLE DRE_SEM_VEIC ADD  QTD_CARTEIRA			FLOAT
ALTER TABLE DRE_SEM_VEIC ADD  QTD_PRODUCAO			FLOAT

ALTER TABLE DRE_SEM_VEIC ADD  CM_ADM_FIXA_OUTRAS_veic	FLOAT
ALTER TABLE DRE_SEM_VEIC ADD  CM_ADM_VAR_COMUNIC		FLOAT
ALTER TABLE DRE_SEM_VEIC ADD  CM_ADM_VAR_COMUNIC_VEIC		FLOAT
SP_HELP DRE_ATRASO

*/
-- RATEIO POR QTDE PRODUCAO  **************************  **************************  **************************
UPDATE	DRE_ATRASO
SET		DESPESA_CADASTRO = @DESPESA_CAD_VEIC / @QTD_PRODUCAO,  
		DESPESA_COMERCIAL = @DESPESA_COML_VEIC / @QTD_PRODUCAO,
		CM_DESP_PESSOAL = @CM_DESP_PESSOAL / @QTD_PRODUCAO,
		CM_DIRETORIA = @CM_DESP_DIRETORIA  / @QTD_PRODUCAO		
WHERE		DT_FECHA = @DTREF
		AND	@QTD_PRODUCAO >0
		AND
			CONVERT(VARCHAR(4),DATEPART(YYYY,DT_BASE))+'-'+RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(MM,DT_BASE))),2)
		 =  CONVERT(VARCHAR(4),DATEPART(YYYY,@DTREF))+'-'+RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(MM,@DTREF))),2)
		-- ANO MES DO CONTRATO = ano mes da producao  = Dta ref
	    -- AND   RIGHT(OPNROPER,1) NOT IN ('A','B','C')			-- SEM RENEGOCIADOS


-- zera valores NULL
UPDATE	DRE_ATRASO
SET		DESPESA_CADASTRO = 0.0
WHERE		DT_FECHA = @DTREF
		AND	DESPESA_CADASTRO IS NULL


-- DESPESA_SUP_VEIC	FLOAT,
--	SP_HELP DRE_ATRASO

-- RATEIO POR QTDE CARTEIRA  **************************  **************************  **************************
UPDATE	DRE_ATRASO
SET		CM_TARIFA   = @CM_TARIFAS_OUTRAS_RECEITA / @QTD_CARTEIRA,
		CM_PROVISAO = @CM_PROVISOES_VEIC  / @QTD_CARTEIRA,
		CM_IMOBILIZADO = @CM_IMOBILIZADO / @QTD_CARTEIRA,
		CM_ALUGUEL  = @CM_ALUGUEL / @QTD_CARTEIRA,
		CM_ADM_FIXA = @CM_ADM_FIXA_VEIC / @QTD_CARTEIRA,
		CM_ADM_VAR  = @CM_ADM_VAR_VEIC  / @QTD_CARTEIRA,
		CM_ADM_OUTRAS_TTL2  = @CM_ADM_FIXA_OUTRAS_veic  / @QTD_CARTEIRA,
		CM_ADM_OUTRAS_TTL3  = 0.0,
		CM_ADM_VAR_COM =  @CM_ADM_VAR_COMUNIC_VEIC   / @QTD_CARTEIRA,
		CUSTO_COBRANCA = @CUSTO_COBRANCA_VEIC    / @QTD_CARTEIRA,
		CM_TARIFA_DESPESA =@CM_TARIFAS_DEPESA_OPER_VEIC   / @QTD_CARTEIRA

-- DESP PESSOAL E DIRETORIA POR PRODUCAO
--		CM_DESP_PESSOAL   =@CM_DESP_PESSOAL_VEIC  / @QTD_CARTEIRA,
--		CM_DIRETORIA =@CM_DIRETORIA_VEIC  / @QTD_CARTEIRA
--,		CM_ADM_VAR_CM  = 0.0
WHERE		DT_FECHA = @DTREF
		AND	NVL_RISCO NOT IN ( 'HH') -- '' somente sem prejuizo
--	AND		SLDO_INSCRITO > 0.0  -- ESTAH NA CARTEIRA E TEM SALDO
	


-- SP_HELP   DRE_ATRASO
-- SP_HELP   DRE_SEM_VEIC
--ISNULL(CM_PROVISAO,0.0) +ISNULL(CM_TARIFA_DESPESA,0.0)+
-- ISNULL(CM_IMOBILIZADO,0.0) + 
-- ISNULL(CM_DESP_PESSOAL,0.0) + ISNULL(CM_DIRETORIA,0.0) 
--+ ISNULL(CM_ALUGUEL,0.0) +ISNULL(CM_ADM_FIXA,0.0) + 
-- ISNULL(CM_ADM_VAR_CM,0.0) 

--+ ISNULL(CM_ADM_OUTRAS_TTL2,0.0) + ISNULL(CM_ADM_OUTRAS_TTL3,0.0) +
-- ISNULL(CM_ADM_VAR_COM,0.0) 
--		MARGEM_CAIXA   =  @MARGEM_CAIXA_VEIC    / @QTD_CARTEIRA	

-- RATEIO POR SALDO CARTEIRA  **************************  **************************  **************************
DECLARE @TTL_SLD FLOAT 
SET @TTL_SLD = (SELECT	SUM(SLDO_INSCRITO) FROM DRE_ATRASO (NOLOCK)
				WHERE	DT_FECHA = @DTREF
--					AND	SLDO_INSCRITO > 0.0 
 ) -- ESTAH NA CARTEIRA E TEM SALDO
-- RATEIO PELO SALDO EM CARTEIRA
			-- SLDO_INSCRITO  /  @TTL_SLD
UPDATE		DRE_ATRASO
	SET		MARGEM_CAIXA   =  @MARGEM_CAIXA_VEIC  *  PROPORCAO_CARTEIRA
WHERE		DT_FECHA = @DTREF
--	AND		SLDO_INSCRITO > 0.0  -- ESTAH NA CARTEIRA E TEM SALDO

-- COBRANCA RATEIO PELA QTDE EM COBRANCA OU EM RECUPERACAO **************************  **************************


-- RECEITA DE ATRASO ****************************************************
--		-PDD	QDO				NVL_RISCO_ANT = 'HH' AND NVL_RISCO=''
/*
711050100600000000	7.1.1.05.01.006-5	Capital de giro - Confissao de divida 	
711050101100000000	7.1.1.05.01.011-3	Mora - capital de giro
711050201100000000	7.1.1.05.02.011-0	Mora - crédito pessoal 

711050201200000000	7.1.1.05.02.012-7	Mora - crédito pessoal - loja
711050301000000000	7.1.1.05.03.010-0	Multa - Auto Financiamento 
711050301200000000	7.1.1.05.03.012-4	Mora - Auto Financiamento 

711150101000000000	7.1.1.15.01.010-3	Multa - financiamentos
711150101100000000	7.1.1.15.01.011-0	Mora - financiamentos
719993000200000000  7.1.9.99.30.002-2	Juros s/títulos vencidos - lojas
719300000100000000	7.1.9.30.00.001-3	Recuperação de Encargos e despesa

SELECT	MOV_D_C ,*
	FROM	GER_BASE_BALANCETE (NOLOCK)  	WHERE	DT_FECHA='20150430'  AND EMPRESA=99	
	AND CONTA in ('894103000100000000','894203000100000000')

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '7.1.1.05.01.006-5','7.1.1.05.01.011-3',
'7.1.1.05.02.011-0')
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '7.1.1.05.02.012-7','7.1.1.05.03.010-0',
'7.1.1.05.03.012-4')

select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '7.1.1.15.01.010-3','7.1.1.15.01.011-0',
'7.1.9.99.30.002-2','7.1.9.30.00.001-3')

-- NOTA SHOP RECEITA DE ATRASO 250 A 300 K
717991000700000000 7.1.7.99.10.007-5 Serviços de cobrança
select * from CONTABIL_SANTANA..PLANO_CONTABIL (NOLOCK) where nume_cont_fmtd in ( '7.1.7.99.10.007-5')

DECLARE     @RECEITA_ATRASO FLOAT
SET			@RECEITA_ATRASO 

--ISNULL(PASLDXMLT,0.0)+ISNULL(PASLDXMR,0.0)
*/
UPDATE		DRE_ATRASO
	SET		VLR_RECEITA_ATRASO   =  ISNULL(PASLDXMLT,0.0)+ISNULL(PASLDXMR,0.0)
WHERE		DT_FECHA = @DTREF

UPDATE		DRE_ATRASO
	SET		VLR_RECEITA_ATRASO   =  VLR_RECEITA_ATRASO + ISNULL(VLR_RECEITA_ATRASO,0.0) + 
			-- RECUPERACAO BNDU ?!
			CASE WHEN NVL_RISCO_ANT ='HH' AND NVL_RISCO='' THEN PDD * (-1.00) 
				 ELSE 0.0  END 
WHERE		DT_FECHA = @DTREF

-- Serviços de cobrança RECEITA ATRASO - NOTA SHOP  ************************** 22AGO15
-- NAO TEM A CONTA DE 2012 P/ TRAS
-- EM 2013, 2014, 2015
/*  -- REMOVI P/ TESTE 2-SET-2015
IF DATEPART(YYYY,@DTREF ) <= 2015
BEGIN
		DECLARE @RECEITA_ATRASO_NOTASHOP FLOAT
				SET	@RECEITA_ATRASO_NOTASHOP =	 ISNULL((SELECT	SUM(MOV_D_C)
												FROM	GER_BASE_BALANCETE (NOLOCK) 
												WHERE	DT_FECHA=@DTREF AND EMPRESA=99   -- DESPESA DE CAPTACAO PARCIAL
													AND CONTA IN ('717991000700000000')),0.0) 
		SELECT	@RECEITA_ATRASO_NOTASHOP AS RECEITA_ATR_NOTASHOP
		-- RATEIO PELA QTDE EM ATRASO , SOMENTE P/ CONTRATOS EM ATRASO
		UPDATE		DRE_ATRASO
			SET		VLR_RECEITA_ATRASO   =   ISNULL(VLR_RECEITA_ATRASO,0.0) +  @RECEITA_ATRASO_NOTASHOP / 
					( SELECT COUNT(*) FROM DRE_ATRASO (NOLOCK)  WHERE		DT_FECHA = @DTREF AND NVL_RISCO BETWEEN 'B' AND 'H')
		WHERE		DT_FECHA = @DTREF
				AND NVL_RISCO BETWEEN 'B' AND 'H'
END
*/

-- TOTAL DE DESPESAS  **************************  **************************  **************************
--		SP_HELP DRE_ATRASO  ISNULL(CM_TARIFA,0.0) +
UPDATE	DRE_ATRASO
SET		CUSTO_MANUTENCAO   =  ISNULL(CM_PROVISAO,0.0) +ISNULL(CM_TARIFA_DESPESA,0.0)+
ISNULL(CM_IMOBILIZADO,0.0) + ISNULL(CM_DESP_PESSOAL,0.0) + ISNULL(CM_DIRETORIA,0.0) 
+ ISNULL(CM_ALUGUEL,0.0) +
ISNULL(CM_ADM_FIXA,0.0) + ISNULL(CM_ADM_VAR,0.0) 
+ ISNULL(CM_ADM_OUTRAS_TTL2,0.0) + ISNULL(CM_ADM_OUTRAS_TTL3,0.0) +
ISNULL(CM_ADM_VAR_COM,0.0) 
WHERE		DT_FECHA = @DTREF
--	AND		SLDO_INSCRITO > 0.0  -- ESTAH NA CARTEIRA E TEM SALDO

-- ago-15
-- CALCULO DO LUCRO BRUTO  TODOS
/*
UPDATE	DRE_ATRASO
SET		VLR_LUCRO_BRUTO   = VLR_RECEITA + MARGEM_CAIXA + 
				-- RECEITA ATRASO
				VLR_RECEITA_ATRASO 
							- DESP_CAPT_OPER - VLR_COMISSAO - DESPESA_CONTRATO - DESPESA_CADASTRO - DESPESA_COMERCIAL
							- CUSTO_MANUTENCAO - CUSTO_COBRANCA- DESPESA_ATRASO 
WHERE		DT_FECHA = @DTREF
--	AND		SLDO_INSCRITO > 0.0  -- ESTAH NA CARTEIRA E TEM SALDO
--	AND		SLDO_INSCRITO > 0.0  -- ESTAH NA CARTEIRA E TEM SALDO
*/

-- ************************************************ lucro ********************
-- SET-15
UPDATE	DRE_ATRASO
SET		VLR_LUCRO_BRUTO   = VLR_RECEITA_FIN + MARGEM_CAIXA + 
				-- RECEITA ATRASO
				VLR_RECEITA_ATRASO 
							- DESP_CAPT_OPER - 
		--VLR_COMISSAO
		(CASE WHEN	DATEPART(YYYY,DT_BASE) = DATEPART(YYYY,@DTREF) 
				AND	DATEPART(MM,DT_BASE)   = DATEPART(MM,@DTREF)   THEN
					--ISNULL(VLR_COMISSAO_TERCO_AV,0.0) 
					ISNULL(VLR_RETORNO,0.0) + ISNULL(vlr_comissao_15,0.0) +ISNULL(REPASSE_AGENTE_PROMOT,0.0) 
			   ELSE
					ISNULL(VLR_RETORNO,0.0) END  )
			- DESPESA_CONTRATO - DESPESA_CADASTRO - DESPESA_COMERCIAL
			- CUSTO_MANUTENCAO - CUSTO_COBRANCA- DESPESA_ATRASO 
			- 		--VLR_IMPOSTOS
		(CASE WHEN	DATEPART(YYYY,DT_BASE) = DATEPART(YYYY,@DTREF) 
				AND	DATEPART(MM,DT_BASE)   = DATEPART(MM,@DTREF)   THEN
					--ISNULL(VLR_COMISSAO_TERCO_AV,0.0) 
					VLR_ISS + VLR_PIS+  VLR_COFINS  
			   ELSE
					0.0 END  )
		-  isnull(PDD,0.0)
			-- provisiona se for despesa  ?? recuperacao conta!!
			--			-  case when isnull(PDD,0.0)<=0.0 then 0.0 else isnull(PDD,0.0) end	
WHERE		DT_FECHA = @DTREF


-- RATEIO POR LUCRO BRUTO  **************************  **************************  **************************
-- set-15
DECLARE @ttl_lucro FLOAT
SET		@ttl_lucro = (select sum(VLR_LUCRO_BRUTO) FROM DRE_ATRASO (NOLOCK) WHERE	DT_FECHA  = @DTREF )

SET		@TRIBUTO_IRPJ_VEIC = CASE WHEN @ttl_lucro > 0.0  THEN @ttl_lucro * 0.25 ELSE 0.0 END
SET		@TRIBUTO_CSSL_VEIC = CASE WHEN @ttl_lucro > 0.0  THEN @ttl_lucro * 0.15 ELSE 0.0 END

UPDATE	DRE_ATRASO
SET		vlr_IRPJ   =  @TRIBUTO_IRPJ_VEIC  * VLR_LUCRO_BRUTO / TTL_LUCRO,
		VLR_CSSL   =  @TRIBUTO_CSSL_VEIC  * VLR_LUCRO_BRUTO / TTL_LUCRO
--,		VLR_CRED_TRIB = @TRIBUTO_CRED_TRIB_VEIC  * VLR_LUCRO_BRUTO / TTL_LUCRO,
--		OUTRAS_TX	  = @TRIBUTO_OUTRAS_TXA_VEIC * VLR_LUCRO_BRUTO / TTL_LUCRO
		-- se tiver lucro, paga imposto
FROM	(SELECT		SUM(VLR_LUCRO_BRUTO) AS TTL_LUCRO FROM DRE_ATRASO D (NOLOCK) 
			WHERE	DT_FECHA  = @DTREF AND	VLR_LUCRO_BRUTO > 0.0 ) AS TTL
WHERE		DT_FECHA  = @DTREF
	AND		VLR_LUCRO_BRUTO > 0.0  -- SE TEM LUCRO, PAGA IMPOSTO RATEADO PELO VALOR LUCRO BRUTO
--	AND		SLDO_INSCRITO > 0.0  -- ESTAH NA CARTEIRA E TEM SALDO

/*
-- SET-15
UPDATE	DRE_ATRASO
SET		vlr_IRPJ   =  0.25  * VLR_LUCRO_BRUTO ,
		VLR_CSSL   =  0.15  * VLR_LUCRO_BRUTO ,
		VLR_CRED_TRIB = 0.0,
		OUTRAS_TX	  = 0.0
WHERE		DT_FECHA  = @DTREF
	AND		VLR_LUCRO_BRUTO > 0.0  -- SE TEM LUCRO


-- TTL IMPOSTOS  -- TODOS
UPDATE	DRE_ATRASO
SET		VLR_IMPOSTOS   = (CASE WHEN	DATEPART(YYYY,DT_BASE) = DATEPART(YYYY,@DTREF) 
								AND	DATEPART(MM,DT_BASE)   = DATEPART(MM,@DTREF)	THEN
								VLR_ISS + VLR_PIS+  VLR_COFINS ELSE 0.0 END )
						+ vlr_IRPJ + VLR_CSSL   -- SEM CRED TRIBUT NO GERENCIAL
WHERE		DT_FECHA = @DTREF
*/


-- SELECT VLR_LUCRO_BRUTO,* FROM DRE_ATRASO WHERE DT_FECHA='20150430'
-- SELECT SUm(VLR_LUCRO_BRUTO,* FROM DRE_ATRASO WHERE DT_FECHA='20150430'

-- RATEIO POR LUCRO BRUTO  **************************  **************************  **************************
-- SP_HELP DRE_ATRASO
-- SP_HELP DRE_SEM_VEIC
-- ago-15
-- RATEIO DO LUCRO BRUTO  TODOS
/*
UPDATE	DRE_ATRASO
SET		vlr_IRPJ   =  @TRIBUTO_IRPJ_VEIC  * VLR_LUCRO_BRUTO / TTL_LUCRO,
		VLR_CSSL   =  @TRIBUTO_CSSL_VEIC  * VLR_LUCRO_BRUTO / TTL_LUCRO,
		VLR_CRED_TRIB = @TRIBUTO_CRED_TRIB_VEIC  * VLR_LUCRO_BRUTO / TTL_LUCRO,
		OUTRAS_TX	  = @TRIBUTO_OUTRAS_TXA_VEIC * VLR_LUCRO_BRUTO / TTL_LUCRO
FROM	(SELECT		SUM(VLR_LUCRO_BRUTO) AS TTL_LUCRO FROM DRE_ATRASO D (NOLOCK) 
			WHERE	DT_FECHA  = @DTREF AND	SLDO_INSCRITO > 0.0 ) AS TTL
WHERE		DT_FECHA  = @DTREF
	AND		SLDO_INSCRITO > 0.0  -- ESTAH NA CARTEIRA E TEM SALDO
--	AND		SLDO_INSCRITO > 0.0  -- ESTAH NA CARTEIRA E TEM SALDO

-- TTL IMPOSTOS  -- TODOS
UPDATE	DRE_ATRASO
SET		VLR_IMPOSTOS   = VLR_IOF + VLR_ISS + VLR_PIS+  VLR_COFINS + vlr_IRPJ + VLR_CSSL - VLR_CRED_TRIB
WHERE		DT_FECHA = @DTREF
--	AND		SLDO_INSCRITO > 0.0  -- ESTAH NA CARTEIRA E TEM SALDO
*/
-- SP_HELP DRE_ATRASO

--   declare @DTREF DATETIME SET @DTREF ='20150630'
--		declare @DTREF DATETIME SET @DTREF ='20150131'
--		declare @DTREF DATETIME SET @DTREF ='20150531'
--   declare @DTREF DATETIME SET @DTREF ='20150630'

SELECT 
		DESCR_TIPO	AS SEGMENTO,
		RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(DD,DT_FECHA))),2)+'/'+ 
		RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(MM,DT_FECHA))),2) +'/'+
		CONVERT(VARCHAR(4),DATEPART(YYYY,DT_FECHA))		AS DATA_BASE,
		ISNULL(CONTRATOoriginal,OPNROPER ) AS CONTRATO_ORIGINAL,
		NVL_RISCO	AS NIVEL_RISCO, 
		LOAN		AS LOAN_TO_VALUE,
		OPQTDDPARC	AS PRAZO_CONTRATO,
		PDECOR		AS NUMERO_PARCELA,
		CLCEPFIS	AS CEP_CLIENTE,
		CLCIDFIS	AS CIDADE_CLIENTE,
		CLUFFIS		AS ESTADO_CLIENTE,
		CLRENDA		AS RENDA_CLIENTE,
		OCUPACAO	AS OCUPACAO_CLIENTE,
		IDADE		AS IDADE_CLIENTE,
		ClSexo		AS SEXO,

		CASE WHEN ClESTciv='1'  THEN 'SOLTEIRO'
			 WHEN ClESTciv='2'  THEN 'CASADO'
			 WHEN ClESTciv='3'  THEN 'DESQUITADO'
			 WHEN ClESTciv='4'  THEN 'DIVORCIADO'
			 WHEN ClESTciv='5'  THEN 'VIUVO'
			 WHEN ClESTciv='9'  THEN 'OUTROS'
			 ELSE '' END	
			AS ESTADO_CIVIL,
			
		CASE WHEN TIPO_CASA='A' THEN 'Alugada'
			 WHEN TIPO_CASA='C' THEN 'C/Pais'
			 WHEN TIPO_CASA='D' THEN 'De Familiares'
			 WHEN TIPO_CASA='E' THEN 'Da Empresa'
			 WHEN TIPO_CASA='F' THEN 'Financiada'
			 WHEN TIPO_CASA='H' THEN 'Hotel'
			 WHEN TIPO_CASA='O' THEN 'Outros'
			 WHEN TIPO_CASA='P' THEN 'Própria'
			 ELSE '' END AS TIPO_CASA_CLIENTE,

		LojaCod AS LOJA,
		LojaCEP AS CEP_LOJA,
		LojaCIDADE AS CIDADE_LOJA,
		LojaUF	AS UF_LOJA,
		AGENTEcod AS AGENTE,
		OperadorCod	AS OPERADOR,
		--''	AS 
		RWA_VEICULOS,
		TC		AS TARIFA_CONTRATACAO,
		--DESP_PESSOAL_SUP
		DESPESA_CADASTRO AS CUSTO_CONTRATACAO,

-- ago-15 em 2015 , acho q tem 2x a parte da TC
--			ISNULL(VLR_RETORNO,0.0) + ISNULL(VLR_COMISSAO,0.0) +ISNULL(REPASSE_AGENTE_PROMOT,0.0) 


--		ISNULL(VLR_COMISSAO_TERCO_AV,0.0) +ISNULL(VLR_COMISSAO_DIFERIDA_36AVOS,0.0) AS CUSTO_COMISSAO,
		CASE 
/* -- comentado em 14/07/2017  ****************
			WHEN	DATEPART(YYYY,DT_BASE) IN ( 2015,2016,2017) AND DATEPART(YYYY,@DTREF) IN (2015,2016,2017)  -- 2015
				AND	DATEPART(MM,DT_BASE)   = DATEPART(MM,@DTREF)THEN
					--ISNULL(VLR_COMISSAO_TERCO_AV,0.0) 
					ISNULL(VLR_RETORNO,0.0) + ISNULL(vlr_comissao_15,0.0) +ISNULL(REPASSE_AGENTE_PROMOT,0.0) 
					-- VLR_COMISSAO  = 1,5% + parte TC
					-- REPASSE_AGENTE_PROMOT = parte TC
*/
			WHEN	DATEPART(YYYY,DT_BASE) IN ( 2015) AND DATEPART(YYYY,@DTREF) IN (2015)  -- 2015 1/3 comiss  -- alterei + terco
				AND	DATEPART(MM,DT_BASE)   = DATEPART(MM,@DTREF)THEN
					ISNULL(VLR_COMISSAO_TERCO_AV,0.0) +
					ISNULL(VLR_RETORNO,0.0) + ISNULL(vlr_comissao_15,0.0) +ISNULL(REPASSE_AGENTE_PROMOT,0.0) 
					-- VLR_COMISSAO  = 1,5% + parte TC
					-- REPASSE_AGENTE_PROMOT = parte TC

			WHEN	DATEPART(YYYY,DT_BASE) IN ( 2015) AND DATEPART(YYYY,@DTREF) IN (2015)  -- 2016 2/3 comiss  -- alterei + 2 tercos
				AND	DATEPART(MM,DT_BASE)   = DATEPART(MM,@DTREF)THEN
					ISNULL(COMISSAO_2_3,0.0) +
					ISNULL(VLR_RETORNO,0.0) + ISNULL(vlr_comissao_15,0.0) +ISNULL(REPASSE_AGENTE_PROMOT,0.0) 
		
			WHEN	DATEPART(YYYY,DT_BASE) IN ( 2017) AND DATEPART(YYYY,@DTREF) IN (2017)  -- 2017 sem terços
				AND	DATEPART(MM,DT_BASE)   = DATEPART(MM,@DTREF)THEN
					ISNULL(VLR_RETORNO,0.0) + ISNULL(vlr_comissao_15,0.0) +ISNULL(REPASSE_AGENTE_PROMOT,0.0) 
					-- VLR_COMISSAO  = 1,5% + parte TC
					-- REPASSE_AGENTE_PROMOT = parte TC


			 WHEN	DATEPART(YYYY,DT_BASE) = 2014 AND DATEPART(YYYY,@DTREF) = 2014	-- 2014 mantido
				AND	DATEPART(MM,DT_BASE)   = DATEPART(MM,@DTREF)THEN
					--ISNULL(VLR_COMISSAO_TERCO_AV,0.0) 
					ISNULL(VLR_RETORNO,0.0) + ISNULL(vlr_comissao_15,0.0) +ISNULL(REPASSE_AGENTE_PROMOT,0.0) 
			 WHEN	DATEPART(YYYY,DT_BASE) = 2013 AND DATEPART(YYYY,@DTREF) = 2013	-- 2013
				AND	DATEPART(MM,DT_BASE)   = DATEPART(MM,@DTREF)THEN
					--ISNULL(VLR_COMISSAO_TERCO_AV,0.0) 
					ISNULL(VLR_RETORNO,0.0) + ISNULL(vlr_comissao_15,0.0) +ISNULL(REPASSE_AGENTE_PROMOT,0.0) 
			 WHEN	DATEPART(YYYY,DT_BASE) = 2012 AND DATEPART(YYYY,@DTREF) = 2012	-- 2012
				AND	DATEPART(MM,DT_BASE)   = DATEPART(MM,@DTREF)THEN
					--ISNULL(VLR_COMISSAO_TERCO_AV,0.0) 
					ISNULL(VLR_RETORNO,0.0) + ISNULL(vlr_comissao_15,0.0) +ISNULL(REPASSE_AGENTE_PROMOT,0.0) 
			 WHEN	DATEPART(YYYY,DT_BASE) = 2011 AND DATEPART(YYYY,@DTREF) = 2011	-- 2011
				AND	DATEPART(MM,DT_BASE)   = DATEPART(MM,@DTREF)THEN
					--ISNULL(VLR_COMISSAO_TERCO_AV,0.0) 
					ISNULL(VLR_RETORNO,0.0) + ISNULL(vlr_comissao_15,0.0) +ISNULL(REPASSE_AGENTE_PROMOT,0.0) 
			 WHEN	DATEPART(YYYY,DT_BASE) = 2010 AND DATEPART(YYYY,@DTREF) = 2010	-- 2010
				AND	DATEPART(MM,DT_BASE)   = DATEPART(MM,@DTREF)THEN
					--ISNULL(VLR_COMISSAO_TERCO_AV,0.0) 
					ISNULL(VLR_RETORNO,0.0) + ISNULL(vlr_comissao_15,0.0) +ISNULL(REPASSE_AGENTE_PROMOT,0.0) 
			 WHEN   PDECOR	BETWEEN 1 AND	OPQTDDPARC  -- NO PRAZO DO CONTRATO
				THEN	ISNULL(VLR_RETORNO,0.0) --  RETORNO DIFERIDO
			 ELSE	0.0 
			 END 	AS CUSTO_COMISSAO,

		ISNULL(VLR_RECEITA_FIN,0.0) AS RECEITA_FINANCEIRA,
		DESP_CAPT_OPER AS CUSTO_FUNDING,

		--  FALTA
		case when datepart(mm,DT_FECHA) = 12 then CUSTO_MANUTENCAO/1.0 else CUSTO_MANUTENCAO end as CUSTO_MANUTENCAO, 
		MARGEM_CAIXA, 

		/*CASE WHEN NVL_RISCO_ANT ='HH' AND NVL_RISCO='' THEN PDD * (-1.00) +ISNULL(PASLDXMLT,0.0)+ISNULL(PASLDXMR,0.0) 
				ELSE ISNULL(PASLDXMLT,0.0)+ISNULL(PASLDXMR,0.0)  END	
		AS */ 
		VLR_RECEITA_ATRASO AS RECEITA_ATRASO,

		--  FALTA
		CUSTO_COBRANCA, 
		DESPESA_ATRASO, 

		PDD  AS DESPESA_PROVISAO, 

-- AGO15
		--ISNULL(VLR_IOF,0.0)  SEM IOF 12 GER X 122 FUNCAO
--		ISNULL(VLR_ISS,0.0) + ISNULL(VLR_PIS,0.0) + ISNULL(VLR_COFINS,0.0) +				ISNULL(vlr_IRPJ,0.0)+ISNULL(VLR_CSSL,0.0) - ISNULL(VLR_CRED_TRIB,0.0)+ ISNULL(OUTRAS_TX,0.0)

-- SET15
--		ISNULL(VLR_IMPOSTOS,0.0) 
		-- IMPOSTOS PAGOS NA CABECA + IR E CSLL RATEADOS
		CASE WHEN	DATEPART(YYYY,DT_BASE) = DATEPART(YYYY,@DTREF) 
				AND	DATEPART(MM,DT_BASE)   = DATEPART(MM,@DTREF)THEN
					ISNULL(VLR_ISS,0.0) + ISNULL(VLR_PIS,0.0) + ISNULL(VLR_COFINS,0.0) 
			ELSE 0.0 END + vlr_IRPJ + vlr_CSSL
		AS TRIBUTOS,

		--RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(DD,DT_BASE))),2)+
		'01/'+ 		RIGHT('00'+RTRIM(CONVERT(VARCHAR(2),DATEPART(MM,DT_BASE))),2) +'/'
		+ CONVERT(VARCHAR(4),DATEPART(YYYY,DT_BASE))	 AS DATA_SAFRA
		, ANO_VEICULO, MODELO, SCORE,
		CASE WHEN RIGHT(OPNROPER,1) IN ('A','B','C') THEN 'R' ELSE '' END AS RENEGOCIADO
/*,

		PASLDXMLT,
		PASLDXMR,
		PDD,
		VLR_PDD_ATU,
		VLR_PDD_ANT,
		NVL_RISCO_ANT,
		VLR_PARCELA,
		VLR_RETORNO,
		VLR_RECEITA,
		VLR_IOF,
		VLR_ISS,
		VLR_PIS,
		VLR_COFINS,
		VLR_CAPTACAO,
		vlr_IRPJ,
		VLR_CSSL,
		VLR_CRED_TRIB,
		OUTRAS_TX,
		REC_APLIC_SLDO_CX,
		REPASSE_AGENTE_6P,
		RETORNO_LOJA,
		REPASSE_AGENTE_PROMOT,
		DESP_CAPT_SLD_CX,
		DESP_CAPT_OPER,
		DESP_PESSOAL_VDA,
		DESP_PESSOAL_SUP,
		SLDO_INSCRITO,
		PROPORCAO_CARTEIRA,
		VLR_COMISSAO,
		VLR_COMISSAO_TERCO_AV,
		VLR_COMISSAO_DIFERIDA_36AVOS,
		VLR_FINANCIADO  AS VLR_OPERADO,
		DT_BASE,
		vlr_comissao_diferida_pzo_Op,
		COMISSAO_AV,
		SLD_DIFERIR_2_3,
		OPNROPER,	
		PARC,
		LIBERADO,
		TABELADO,
		OPTAC,
		COMISSAO_2_3,
		VLR_COMISSAO_15,
		DESPESA_CONTRATO,
		DESPESA_CADASTRO,
DESPESA_COMERCIAL,
CM_TARIFA,
CM_PROVISAO,
CM_TARIFA_DESPESA,
CM_IMOBILIZADO,
CM_DESP_PESSOAL,
CM_DIRETORIA,
CM_ALUGUEL,
CM_ADM_FIXA,
CM_ADM_VAR,
CM_ADM_OUTRAS_TTL2,
CM_ADM_OUTRAS_TTL3,
CM_ADM_VAR_COM,
CUSTO_COBRANCA,
DESPESA_ATRASO,
VLR_IMPOSTOS,
VLR_LUCRO_BRUTO,
CUSTO_MANUTENCAO,
VLR_RECEITA_ATRASO 
*/
	FROM	DRE_ATRASO (NOLOCK)
	WHERE	DT_FECHA = @DTREF

--	AND NOT (NVL_RISCO =''	AND NVL_RISCO_ANT='')		-- SEM '' NIVEL

--	AND		PDD <> 0.0  -- ESTAH NA CARTEIRA E TEM SALDO
--	AND		VLR_RECEITA   > 0.0  -- E TEM RECEITA  (LIQUIDADO NO MES)
 
END
GO


SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
