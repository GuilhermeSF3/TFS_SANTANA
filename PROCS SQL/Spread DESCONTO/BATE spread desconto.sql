use sig

-- carteira do desconto
SELECT	* 	FROM			FinCilDbs..CilTblRat 	R	(NOLOCK)	
			where	ratDatRef = '20180131'    -- MES Ref Fechamento
				--and ratcodemp = 1
				and CrsCodRatFIM <> 'HH'  -- CARTEIRA SEM PREJUIZO
				and ISNULL(RatValSaldo,0.0) > 0.0
				and MOPCOD IN ('0301','0302') 

				CASE	WHEN MOPCOD IN ('0216')			THEN 'CG'   -- '0215' ANTES
						WHEN MOPCOD IN ('0301','0302')  THEN 'D'
						WHEN MOPCOD IN ('0203','0401','0402')  THEN 'V'
						--WHEN MOPCOD IN ('0216')			THEN 'R'
						WHEN MOPCOD IN ('0206','1511')  THEN 'CP'
						END,	  		-- PRODUTO

				COUNT(RATVALSALDO)  ,	-- QTDE
				SUM(RATVALSALDO)	
		--	SELECT RATCODSIS,MOPCOD,SUM(RATVALSALDO)	

ratcodcontr	mopcod	ratcodcli	crscodratcli	crscodratori	crscodratope	crscodratcsd	crscodratfim	ratcodctb	ratvalsaldo	ratvalpddori	ratvalpdd	ratpctpdd
1000134                                 	0302	69324200      	B 	B 	B 	E 	E 	NULL	2612.00	NULL	783.60	30.00


-- exec scr_SPREAD_DESCONTO_analitico_prod  '20180131','20180101'
220  <>  219   ok

-- exec scr_SPREAD_DESCONTO_analitico_prod  '20171231','20171201'
201  ok
-- exec scr_SPREAD_DESCONTO_analitico_prod  '20180131','20171201'

select * FROM	COMERCIAL_PRODUCAO (NOLOCK)  WHERE	DT_FECHA='20180131' and produto='d' and vlr_op>0.0

select * FROM	COMERCIAL_PRODUCAO (NOLOCK)  WHERE	DT_FECHA='20180331'
sp_help COMERCIAL_PRODUCAO 
select * FROM	 NETFACTOR..NFOPERACAO C (NOLOCK) WHERE OPECODIGO= 1002259
AND opeStatus IN ( 61, 71 )    -- EFETIVADAS                    
 --AND opeData BETWEEN  @DTINI AND @DTFIM                     
 AND (opeCodigoCobranca IS NULL OR opeCodigoCobranca = 0)                     
 AND EMPCODIGO IN ( 1,2) -- SANTANA SEM FIDC , FIDIC EMPRESA 2                    
 AND CONVERT(FLOAT,IDGCODIGO) IN (SELECT  CONVERT(FLOAT,COD_MODA)                     
          FROM TModa_tipo_prod (NOLOCK) WHERE COD_PROD='D' )                    
010201  
SELECT * FROM TModa_tipo_prod (NOLOCK) WHERE COD_PROD='D'
SELECT * FROM Ttipo_prod (NOLOCK) WHERE COD_PROD='D'

SELECT * FROM 
(SELECT * FROM TModa_tipo_prod (NOLOCK) WHERE COD_PROD='D' ) AS M,
(SELECT * FROM Ttipo_prod (NOLOCK) WHERE COD_PROD='D') AS T
WHERE T.COD_MODALIDADE =M.COD_MODALIDADE
AND 


-- AJUSTA INDICE
create index COMERCIAL_PRODUCAO_idx2 on COMERCIAL_PRODUCAO (PRODUTO,DT_BASE,NUM_OPE)


SP_HELP SPREAD_HISTORICO
SP_HELP AUX_SPREAD_ANALITICO

SP_HELP COMERCIAL_PRODUCAO

SELECT * FROM COMERCIAL_PRODUCAO (NOLOCK) WHERE DT_FECHA ='20180407' AND PRODUTO='D' AND VLR_OP >0.0

DT_FECHA	PRODUTO	NUM_OPE	DT_BASE	VLR_OP	VLR_PARC	VLR_PRESENTE	VLR_RECEITA	VLR_FUTURO	VLR_LIBERADO	VLR_TC	VLR_TARIFA	VLR_IOF	VLR_FIPE	SCORE	PRAZO	PLANO	TAXA	RETORNO	TAXA_SEM_RET	ATRASO	dtVencParc	DT_PAGTO	RENEGOCIADO	RATING	CODCLI	CODPROD	CODMODA	AGENTE	VEICULO	CODOPER	CODLOJA	ANO_MODELO	TX_X_VLR	PRZ_X_VLR	BORDERO	FX_ANO	FX_PLANO	NVL_RISCO	PLANO_X_VLR	TAXA_AA	TX_AA_X_VLR
2018-04-07 00:00:00	D	1001511	2018-04-05 00:00:00	13651,45	0	13394,63	256,820000000002	13651,45	13292,63	50	52	0	0	0	18,88	0	2,99	0	3,06	0	1900-01-01 00:00:00	1900-01-01 00:00:00	0		65	2	2	4	FIDC	0	0		40817,8355	257739,376	0	NULL			257739,376	42,4100692899133	568067,186412752

SELECT * FROM TBL_Spread_DESCONTO_analitico_prod  (NOLOCK) 

-- SELECT * FROM PDD_SEM_VEIC  (NOLOCK) 

SELECT	*	FROM Ttipo_prod (NOLOCK) WHERE COD_PROD='D'

SELECT	*	FROM Ttipo_prod (NOLOCK) WHERE COD_PROD='D'

SELECT	*	FROM P123_HISTORICO (NOLOCK) where dt_fecha='20180331' and agente=159

SP_HELP PDD_SEM_VEIC


SELECT	*	FROM P123_HISTORICO (NOLOCK) where dt_fecha='20180331' and agente=159


SELECT	*	FROM P123_HISTORICO (NOLOCK) where dt_fecha='20180331' and agente=173

SELECT	*	FROM cdcsantanamicrocredito..torg3 (NOLOCK) 
O3CODORG	O3DESCR
000159	DINIZ JUNDIAI

SP_HELP TBL_Spread_DESCONTO_analitico_prod
SP_HELP Ttipo_prod
DROP INDEX PDD_SEM_VEIC.PDD_SEM_VEIC_IDX1 

CREATE INDEX PDD_SEM_VEIC_IDX1 ON PDD_SEM_VEIC (DT_REF,NUM_OPE)

CREATE INDEX PDD_SEM_VEIC_IDX2 ON PDD_SEM_VEIC (NUM_OPE)


SELECT * FROM PDD_SEM_VEIC (NOLOCK) WHERE DT_ref='01_18'
and 

1000089 D 2017-01-19 00:00:00.000  entra na PDD 1 ano depois!

SELECT * 		FROM NETFACTOR..NFoperacao C (NOLOCK) where opecodigo='1000089'

SELECT * FROM PDD_SEM_VEIC (NOLOCK) 