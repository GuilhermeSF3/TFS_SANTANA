USE SIG

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- EXEC [JOB_P123GER] '20160831'


-- PROC CALCULO  [JOB_P123GER] ********************************************************************************************************************************************************
IF EXISTS (SELECT name FROM sysobjects 
         WHERE name = 'JOB_P123GER' AND type = 'P')
   DROP PROCEDURE [dbo].[JOB_P123GER]
GO


CREATE PROCEDURE [dbo].[JOB_P123GER] (@data_ref AS DATETIME) AS
BEGIN


	--  13 MESES				-- MEDIA
	DECLARE @M1  AS DATETIME	-- DT REF	
	DECLARE @M2  AS DATETIME
	DECLARE @M3  AS DATETIME
	DECLARE @M4  AS DATETIME
	DECLARE @M5  AS DATETIME
	DECLARE @M6  AS DATETIME
	DECLARE @M7  AS DATETIME
	DECLARE @M8  AS DATETIME
	DECLARE @M9  AS DATETIME
	DECLARE @M10  AS DATETIME
	DECLARE @M11  AS DATETIME
	DECLARE @M12  AS DATETIME
	DECLARE @M13  AS DATETIME
	DECLARE @M14  AS DATETIME

		-- MES  DE FECHAMENTO
		SET		@M1 = @data_ref

		-- MES ANTERIOR AO DO FECHAMENTO
		SET		@M2 = CONVERT(CHAR(4),DATEPART(YEAR,@M1))+
						RIGHT(RTRIM('00'+CONVERT(CHAR(2),DATEPART(MONTH,@M1))),2)+'01'
		SET		@M2 = DATEADD(DD,-1,@M2)
		--		SELECT @M1, @m2

		set		@M3 = CONVERT(CHAR(4),DATEPART(YEAR,@M2))+
					RIGHT(RTRIM('00'+CONVERT(CHAR(2),DATEPART(MONTH,@M2))),2)+'01'
		SET		@M3=DATEADD(DD,-1,@M3)
		--		SELECT @M1, @M2,@M3

		set  @M4 = CONVERT(CHAR(4),DATEPART(YEAR,@M3))+
					RIGHT(RTRIM('00'+CONVERT(CHAR(2),DATEPART(MONTH,@M3))),2)+'01'
		SET	 @M4=DATEADD(DD,-1,@M4)
		--		  SELECT @M4

	set  @M5 = CONVERT(CHAR(4),DATEPART(YEAR,@M4))+
				RIGHT(RTRIM('00'+CONVERT(CHAR(2),DATEPART(MONTH,@M4))),2)+'01'
	SET	 @M5 = DATEADD(DD,-1,@M5)
	--		 	SELECT @M5

	set  @M6 = CONVERT(CHAR(4),DATEPART(YEAR,@M5))+
				RIGHT(RTRIM('00'+CONVERT(CHAR(2),DATEPART(MONTH,@M5))),2)+'01'
	SET	 @M6 = DATEADD(DD,-1,@M6)

	set  @M7 = CONVERT(CHAR(4),DATEPART(YEAR,@M6))+
				RIGHT(RTRIM('00'+CONVERT(CHAR(2),DATEPART(MONTH,@M6))),2)+'01'
	SET	 @M7 = DATEADD(DD,-1,@M7)

	set  @M8 = CONVERT(CHAR(4),DATEPART(YEAR,@M7))+
				RIGHT(RTRIM('00'+CONVERT(CHAR(2),DATEPART(MONTH,@M7))),2)+'01'
	SET	 @M8 = DATEADD(DD,-1,@M8)

	set  @M9 = CONVERT(CHAR(4),DATEPART(YEAR,@M8))+
				RIGHT(RTRIM('00'+CONVERT(CHAR(2),DATEPART(MONTH,@M8))),2)+'01'
	SET	 @M9 = DATEADD(DD,-1,@M9)

	set		@M10 = CONVERT(CHAR(4),DATEPART(YEAR,@M9))+
				RIGHT(RTRIM('00'+CONVERT(CHAR(2),DATEPART(MONTH,@M9))),2)+'01'
	SET		@M10 = DATEADD(DD,-1,@M10)
	--			SELECT	@M10

	set		@M11 = CONVERT(CHAR(4),DATEPART(YEAR,@M10))+
				RIGHT(RTRIM('00'+CONVERT(CHAR(2),DATEPART(MONTH,@M10))),2)+'01'
	SET		@M11 = DATEADD(DD,-1,@M11)
	--			SELECT	@M11 

	set		@M12 = CONVERT(CHAR(4),DATEPART(YEAR,@M11))+
				RIGHT(RTRIM('00'+CONVERT(CHAR(2),DATEPART(MONTH,@M11))),2)+'01'
	SET		@M12 = DATEADD(DD,-1,@M12)

	set		@M13 = CONVERT(CHAR(4),DATEPART(YEAR,@M12))+
				RIGHT(RTRIM('00'+CONVERT(CHAR(2),DATEPART(MONTH,@M12))),2)+'01'
	SET		@M13 = DATEADD(DD,-1,@M13)

	set		@M14 = CONVERT(CHAR(4),DATEPART(YEAR,@M13))+
				RIGHT(RTRIM('00'+CONVERT(CHAR(2),DATEPART(MONTH,@M13))),2)+'01'
	SET		@M14 = DATEADD(DD,-1,@M14)

SELECT @M14,@M13,@M12,@M11,@M10,@M9,@M8,@M7,@M6,@M5,@M4,@M3,@M2,@M1

	EXEC PRC_p123Ger_MES @M1,''
    EXEC PRC_p123Ger_MES @M2,''
   EXEC PRC_p123Ger_MES @M3,''
   EXEC PRC_p123Ger_MES @M4,''
   EXEC PRC_p123Ger_MES @M5,''
   EXEC PRC_p123Ger_MES @M6,''
   EXEC PRC_p123Ger_MES @M7,''

exec [PRC_P123GER_CALCULO] @M1
exec [PRC_P123GER_CALCULO] @M2
exec [PRC_P123GER_CALCULO] @M3
exec [PRC_P123GER_CALCULO] @M4
exec [PRC_P123GER_CALCULO] @M5
exec [PRC_P123GER_CALCULO] @M6
exec [PRC_P123GER_CALCULO] @M7

-- ********************
--
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M1,@M1
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M2,@M1
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M3,@M1
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M4,@M1
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M5,@M1
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M6,@M1
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M7,@M1

 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M8,@M1
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M9,@M1
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M10,@M1
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M11,@M1
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M12,@M1
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M13,@M1
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M14,@M1		

 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M2,@M2
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M3,@M2
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M4,@M2
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M5,@M2
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M6,@M2
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M7,@M2

 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M3,@M3
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M4,@M3
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M5,@M3
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M6,@M3
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M7,@M3

 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M4,@M4
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M5,@M4
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M6,@M4
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M7,@M4

 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M5,@M5
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M6,@M5
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M7,@M5

 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M6,@M6
 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M7,@M6

 EXEC [dbo].[PRC_P123GER_SCORE_CALC1M] @M7,@M7

EXEC [PRC_Score_13M_CALC] @M1
EXEC [PRC_Score_13M_CALC] @M2
EXEC [PRC_Score_13M_CALC] @M3
EXEC [PRC_Score_13M_CALC] @M4
EXEC [PRC_Score_13M_CALC] @M5
EXEC [PRC_Score_13M_CALC] @M6
EXEC [PRC_Score_13M_CALC] @M7

END
GO
